<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des T√¢ches Enseignants</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Script pour appliquer le th√®me instantan√©ment et √©viter le FOUC -->
    <script>
        (function() {
            /**
             * Applique le th√®me sp√©cifi√© au corps du document.
             * @param {string} theme - Le nom du th√®me ('light', 'dark', 'vintage').
             */
            function applyTheme(theme) {
                document.body.classList.remove('theme-dark', 'theme-vintage', 'theme-light');
                if (theme === 'dark') {
                    document.body.classList.add('theme-dark');
                } else if (theme === 'vintage') {
                    document.body.classList.add('theme-vintage');
                } else {
                    document.body.classList.add('theme-light'); // Th√®me par d√©faut explicite
                }
            }
            // R√©cup√®re le th√®me sauvegard√© ou utilise 'light' par d√©faut.
            const savedTheme = localStorage.getItem('appTheme') || 'light';
            applyTheme(savedTheme);
        })();
    </script>
</head>
<body class="theme-light">
    <header>
        <h1>Application de Gestion des T√¢ches</h1>
        <p>Bienvenue ! S√©lectionnez une option dans la navigation pour commencer.</p>

        <!-- S√©lecteur de th√®me -->
        <div class="theme-switcher no-print">
            <button id="theme-btn-light" data-theme="light" title="Activer le th√®me clair">Clair</button>
            <button id="theme-btn-dark" data-theme="dark" title="Activer le th√®me sombre">Sombre</button>
            <button id="theme-btn-vintage" data-theme="vintage" title="Activer le th√®me vintage">Vintage</button>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <nav>
            <div class="admin-section" style="max-width: 800px; margin: auto;">
                <h2>Navigation</h2>
                <ul>
                    <!-- Liens d'authentification et informations utilisateur -->
                    {% if current_user.is_authenticated %}
                        <li>Connect√©(e) en tant que: <strong>{{ current_user.username }}</strong></li>
                        {# CORRECTION: 'auth.logout' au lieu de 'logout' #}
                        <li><a href="{{ url_for('auth.logout') }}">D√©connexion</a></li>
                    {% else %}
                        {# CORRECTION: 'auth.login' et 'auth.register' #}
                        <li><a href="{{ url_for('auth.login') }}"><strong>Connexion</strong></a></li>
                        <li><a href="{{ url_for('auth.register') }}"><strong>S'inscrire</strong></a></li>
                    {% endif %}

                    <hr>

                    <!-- Liens principaux de l'application -->
                    {% if current_user.is_authenticated and current_user.is_admin %}
                        <li><strong>Outils Administrateur</strong></li>
                        {# CORRECTION: 'admin.page_sommaire', 'admin.page_administration_donnees', etc. #}
                        <li><a href="{{ url_for('admin.page_sommaire') }}">Voir le Sommaire Global</a></li>
                        <li><a href="{{ url_for('admin.page_administration_donnees') }}">G√©rer les donn√©es (Import, R√©assignation)</a></li>
                        <li><a href="{{ url_for('admin.page_administration_utilisateurs') }}">G√©rer les utilisateurs</a></li>
                        <hr>
                    {% endif %}

                    <li><strong>Navigation par Champ :</strong></li>
                    <!-- Boucle pour afficher les liens vers chaque page de champ. -->
                    {% if champs %}
                        {% for champ in champs %}
                        <li>
                            {# CORRECTION: 'views.page_champ' #}
                            <a href="{{ url_for('views.page_champ', champ_no=champ.champno) }}">
                                {{ champ.champno }} - {{ champ.champnom }}
                            </a>
                            {% if champ.estverrouille %}
                                <span class="locked-indicator" title="Ce champ est verrouill√©">üîí</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% else %}
                        <!-- Message affich√© si aucun champ n'est accessible ou trouv√© -->
                        <li>Aucun champ trouv√© ou accessible pour votre compte.</li>
                    {% endif %}
                </ul>
            </div>
        </nav>
    </main>

    <footer>
        <p>¬© {{ SCRIPT_YEAR }} Pour l'√©cole Marie-Rivier ‚ìö</p>
    </footer>

    <!-- Script pour g√©rer les clics et mettre √† jour le th√®me actif -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitcher = document.querySelector('.theme-switcher');
            if (themeSwitcher) {
                const themeButtons = themeSwitcher.querySelectorAll('button');

                /**
                 * Applique la classe de th√®me au corps et met √† jour l'√©tat actif des boutons.
                 * @param {string} theme - Le nom du th√®me √† appliquer.
                 */
                function applyThemeUI(theme) {
                    document.body.classList.remove('theme-dark', 'theme-vintage', 'theme-light');
                    document.body.classList.add(`theme-${theme}`);

                    themeButtons.forEach(btn => btn.classList.remove('active'));
                    const activeButton = document.getElementById(`theme-btn-${theme}`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                    }
                }

                // √âcoute les clics sur le conteneur du s√©lecteur de th√®me pour d√©l√©guer l'√©v√©nement.
                themeSwitcher.addEventListener('click', function(event) {
                    // V√©rifie si l'√©l√©ment cliqu√© est un bouton
                    if (event.target.tagName === 'BUTTON') {
                        const theme = event.target.dataset.theme; // R√©cup√®re le th√®me du data-attribute
                        localStorage.setItem('appTheme', theme); // Sauvegarde le choix de l'utilisateur
                        applyThemeUI(theme); // Applique le th√®me visuellement
                    }
                });

                // Applique le th√®me sauvegard√© au chargement DOM complet.
                const savedTheme = localStorage.getItem('appTheme') || 'light';
                applyThemeUI(savedTheme);
            }
        });
    </script>
</body>
</html>