<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Global</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Style pour les éléments de la page -->
    <style>
        .champ-confirme {
            font-weight: bold;
        }
        .confirm-icon {
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            width: 24px;
            height: 24px;
        }
        .confirm-icon.confirmed path {
            fill: green;
        }
        .confirm-icon.unconfirmed path {
            fill: #ccc;
        }
        .details-link-container {
            text-align: right;
            margin-bottom: 1rem;
        }
        .details-link-container a {
            padding: 0.5rem 1rem;
            background-color: var(--color-primary);
            color: var(--color-background);
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .details-link-container a:hover {
            background-color: var(--color-primary-dark);
        }
    </style>

    <!-- Script pour appliquer le thème instantanément -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('appTheme') || 'light';
            document.documentElement.className = `theme-${savedTheme}`;
        })();
    </script>
</head>
<body class="theme-light">
    <header>
        <h1>
            Tableau de Bord Global
            {% if annee_active %}
                <span class="annee-active-header">(Année : {{ annee_active.libelle_annee }})</span>
            {% endif %}
        </h1>
        <nav>
            <ul>
                {% if current_user.is_authenticated and current_user.is_admin %}
                    <li><a href="{{ url_for('admin.page_sommaire') }}">Tableau de Bord</a></li>
                    <li><a href="{{ url_for('views.index') }}">Navigation par champ</a></li>
                    <li><a href="{{ url_for('admin.page_administration_donnees') }}">Administration (Données)</a></li>
                    <li><a href="{{ url_for('admin.page_administration_utilisateurs') }}">Administration (Utilisateurs)</a></li>
                {% endif %}
                {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('auth.logout') }}">Déconnexion ({{ current_user.username }})</a></li>
                {% else %}
                    <li><a href="{{ url_for('auth.login') }}">Connexion</a></li>
                {% endif %}
            </ul>
        </nav>

        <!-- Sélecteur d'année pour l'administrateur -->
        {% if current_user.is_admin and toutes_les_annees %}
        <div class="year-switcher no-print">
            <label for="annee-selector">Changer l'année de visualisation :</label>
            <select id="annee-selector">
                {% for annee in toutes_les_annees %}
                    <option value="{{ annee.annee_id }}" {% if annee_active and annee.annee_id == annee_active.annee_id %}selected{% endif %}>
                        {{ annee.libelle_annee }} {% if annee.est_courante %}(Courante){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- Sélecteur de thème -->
        <div class="theme-switcher no-print">
            <button id="theme-btn-light" data-theme="light" title="Activer le thème clair">Clair</button>
            <button id="theme-btn-dark" data-theme="dark" title="Activer le thème sombre">Sombre</button>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% if annee_active %}
        <!-- Conteneur principal simplifié -->
        <div class="container-principal-sommaire">
            <!-- Colonne unique pour les moyennes -->
            <div class="colonne-sommaire colonne-gauche" style="width: 100%; margin: auto; max-width: 1200px;">
                <div class="moyenne-generale-contenu">
                    <span>Moyenne générale incluant tous les champs :</span>
                    <span id="moyenne-generale-etablissement">{{ moyenne_generale | format_periodes }} périodes</span>
                </div>
                <div class="moyenne-generale-contenu">
                    <span>Moyenne générale avec les champs confirmés :</span>
                    <span id="moyenne-preliminaire-confirmee">{{ moyenne_preliminaire_confirmee | format_periodes }} périodes</span>
                </div>

                <div>
                    <h2>Moyennes par champ (temps plein)</h2>
                    
                    <!-- Lien vers le détail des tâches -->
                    <div class="details-link-container no-print">
                        <a href="{{ url_for('admin.page_detail_taches') }}">Voir le détail des tâches par enseignant</a>
                    </div>
                    
                    {% if moyennes_par_champ %}
                    <table id="table-moyennes-par-champ">
                        <thead>
                            <tr>
                                <th>N° champ</th>
                                <th>Nom du champ</th>
                                <th>Verrou</th>
                                <th>Nb. Ens. TP</th>
                                <th>Périodes Choisies (TP)</th>
                                <th>Moyenne</th>
                                <th>Diff. / 24p</th>
                                <th>Confirmé</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Le contenu de ce tbody sera trié et inséré par JavaScript. #}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL</td>
                                <td id="total-enseignants-tp" style="font-weight: bold;"></td>
                                <td id="total-periodes-choisies-tp" style="font-weight: bold;"></td>
                                <td></td> <!-- Cellule vide pour la colonne moyenne -->
                                <td id="total-periodes-magiques" style="font-weight: bold;"></td>
                                <td></td> <!-- Cellule vide pour la colonne Confirmé -->
                            </tr>
                        </tfoot>
                    </table>
                    <p id="aucune-moyenne-champ-message" style="display: none;">Aucune donnée de moyenne par champ disponible.</p>
                    {% else %}
                    <p>Aucune donnée de moyenne par champ disponible pour cette année.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
            <div class="flash-messages">
                <li class="warning">Aucune année scolaire n'est active. Les données ne peuvent pas être affichées.</li>
            </div>
        {% endif %}
    </main>

    <footer>
        <p>© ⓚ {{ SCRIPT_YEAR }} Pour l'école Marie-Rivier</p>
    </footer>

    <!-- Script JS spécifique à la page sommaire -->
    <script>
        const INTERVAL_MISE_A_JOUR = 7000;
        const IS_ADMIN = {{ current_user.is_admin | tojson }};

        // --- Fonctions utilitaires et constantes SVG ---
        function formatPeriodes(value) {
            if (value === null || value === undefined) return '';
            const formatter = new Intl.NumberFormat('fr-CA', { minimumFractionDigits: 0, maximumFractionDigits: 2, useGrouping: false, signDisplay: 'auto' });
            return formatter.format(value);
        }
        const SVG_LOCKED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>`;
        const SVG_UNLOCKED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>`;
        const SVG_CONFIRMED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
        const SVG_UNCONFIRMED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" opacity="0.3"/></svg>`;

        document.addEventListener('DOMContentLoaded', function() {
            {% if annee_active %}
                // La mise à jour initiale des données se fait dans mettreAJourDonneesSommaire()
                mettreAJourDonneesSommaire(); 
                setInterval(mettreAJourDonneesSommaire, INTERVAL_MISE_A_JOUR);

                const tableMoyennes = document.getElementById('table-moyennes-par-champ');
                if (tableMoyennes) {
                    tableMoyennes.addEventListener('click', function(event) {
                        const lockIcon = event.target.closest('.lock-icon');
                        const confirmIcon = event.target.closest('.confirm-icon');

                        if (lockIcon && IS_ADMIN) {
                            basculerVerrouChamp(lockIcon.dataset.champNo, lockIcon);
                        } else if (confirmIcon && IS_ADMIN) {
                            basculerConfirmationChamp(confirmIcon.dataset.champNo, confirmIcon);
                        } else if ((lockIcon || confirmIcon) && !IS_ADMIN) {
                            alert("Vous n'avez pas les permissions pour modifier ce statut.");
                        }
                    });
                }
            {% endif %}

            const anneeSelector = document.getElementById('annee-selector');
            if (anneeSelector) {
                anneeSelector.addEventListener('change', function() {
                    const anneeId = this.value;
                    fetch("{{ url_for('admin.api_changer_annee_active') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ annee_id: parseInt(anneeId, 10) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert("Erreur lors du changement d'année de visualisation.");
                        }
                    });
                });
            }
        });

        async function mettreAJourDonneesSommaire() {
            try {
                const response = await fetch("{{ url_for('admin.api_get_donnees_sommaire') }}");
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) { window.location.reload(); return; }
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Mettre à jour les données du tableau et les totaux
                mettreAJourTableauMoyennesChamp(data.moyennes_par_champ || {});
                if (data.grand_totals) {
                    mettreAJourTotaux(data.grand_totals);
                }

                // Mettre à jour les moyennes globales
                const elMoyenneGenerale = document.getElementById('moyenne-generale-etablissement');
                if (elMoyenneGenerale) {
                    elMoyenneGenerale.textContent = (data.moyenne_generale !== undefined && data.moyenne_generale !== null)
                        ? `${formatPeriodes(data.moyenne_generale)} périodes`
                        : `N/A périodes`;
                }
                const elMoyennePrelim = document.getElementById('moyenne-preliminaire-confirmee');
                if (elMoyennePrelim) {
                    elMoyennePrelim.textContent = (data.moyenne_preliminaire_confirmee !== undefined && data.moyenne_preliminaire_confirmee !== null)
                        ? `${formatPeriodes(data.moyenne_preliminaire_confirmee)} périodes`
                        : `N/A périodes`;
                }
            } catch (error) {
                console.error("Erreur lors de la mise à jour du sommaire:", error);
            }
        }

        function mettreAJourTotaux(totals) {
            document.getElementById('total-enseignants-tp').textContent = totals.total_enseignants_tp;
            document.getElementById('total-periodes-choisies-tp').textContent = formatPeriodes(totals.total_periodes_choisies_tp);
            document.getElementById('total-periodes-magiques').textContent = formatPeriodes(totals.total_periodes_magiques);
        }

        async function basculerVerrouChamp(champNo, iconElement) {
            iconElement.style.opacity = '0.5';
            try {
                const response = await fetch(`/admin/api/champs/${champNo}/basculer_verrou`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.message || 'Erreur lors du changement de statut du verrou.');
                await mettreAJourDonneesSommaire();
            } catch (error) {
                console.error(`Erreur bascule verrou pour champ ${champNo}:`, error);
                alert(error.message);
            } finally {
                iconElement.style.opacity = '1';
            }
        }

        async function basculerConfirmationChamp(champNo, iconElement) {
            iconElement.style.opacity = '0.5';
            try {
                const response = await fetch(`/admin/api/champs/${champNo}/basculer_confirmation`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.message || 'Erreur lors du changement de statut de confirmation.');
                await mettreAJourDonneesSommaire();
            } catch (error) {
                console.error(`Erreur bascule confirmation pour champ ${champNo}:`, error);
                alert(error.message);
            } finally {
                iconElement.style.opacity = '1';
            }
        }

        function mettreAJourIconeVerrou(iconElement, estVerrouille) {
            iconElement.className = estVerrouille ? 'lock-icon locked' : 'lock-icon unlocked';
            iconElement.innerHTML = estVerrouille ? SVG_LOCKED : SVG_UNLOCKED;
            iconElement.title = estVerrouille ? 'Champ verrouillé. Cliquer pour déverrouiller.' : 'Champ déverrouillé. Cliquer pour verrouiller.';
        }

        function mettreAJourIconeConfirmation(iconElement, estConfirme) {
            iconElement.className = estConfirme ? 'confirm-icon confirmed' : 'confirm-icon unconfirmed';
            iconElement.innerHTML = estConfirme ? SVG_CONFIRMED : SVG_UNCONFIRMED;
            iconElement.title = estConfirme ? 'Champ confirmé. Cliquer pour annuler.' : 'Champ non confirmé. Cliquer pour confirmer.';
        }

        function comparerNumerosChamp(a, b) {
            const regex = /^(\d+)([a-zA-Z]*)$/;
            const matchA = a.match(regex);
            const matchB = b.match(regex);
            if (matchA && matchB) {
                const numA = parseInt(matchA[1], 10);
                const letterA = matchA[2] || '';
                const numB = parseInt(matchB[1], 10);
                const letterB = matchB[2] || '';
                if (numA !== numB) return numA - numB;
                return letterA.localeCompare(letterB);
            }
            return a.localeCompare(b);
        }

        function mettreAJourTableauMoyennesChamp(moyennesChampData) {
            const tbody = document.querySelector('#table-moyennes-par-champ tbody');
            const aucuneMoyenneMsg = document.getElementById('aucune-moyenne-champ-message');
            const table = document.getElementById('table-moyennes-par-champ');
            if (!tbody || !aucuneMoyenneMsg || !table) return;

            tbody.innerHTML = '';
            const champNosTries = Object.keys(moyennesChampData).sort(comparerNumerosChamp);

            const hasData = champNosTries.length > 0;
            aucuneMoyenneMsg.style.display = hasData ? 'none' : 'block';
            table.style.display = hasData ? '' : 'none';

            if (hasData) {
                champNosTries.forEach(champ_no => {
                    const data = moyennesChampData[champ_no];
                    const row = tbody.insertRow();
                    row.dataset.champNo = champ_no;

                    if (data.est_verrouille) row.classList.add('champ-verrouille-row');
                    if (data.est_confirme) row.classList.add('champ-confirme');

                    row.insertCell().textContent = champ_no;
                    
                    // Rendre le nom du champ cliquable
                    const cellNomChamp = row.insertCell();
                    const link = document.createElement('a');
                    link.href = `/champ/${encodeURIComponent(champ_no)}`;
                    link.textContent = data.champ_nom;
                    cellNomChamp.appendChild(link);

                    const cellStatut = row.insertCell();
                    const lockIcon = document.createElement('span');
                    lockIcon.className = 'lock-icon';
                    lockIcon.dataset.champNo = champ_no;
                    mettreAJourIconeVerrou(lockIcon, data.est_verrouille);
                    cellStatut.appendChild(lockIcon);

                    row.insertCell().textContent = data.nb_enseignants_tp;
                    row.insertCell().textContent = formatPeriodes(data.periodes_choisies_tp);
                    row.insertCell().textContent = formatPeriodes(data.moyenne);
                    row.insertCell().textContent = formatPeriodes(data.periodes_magiques);

                    const cellConfirme = row.insertCell();
                    const confirmIcon = document.createElement('span');
                    confirmIcon.className = 'confirm-icon';
                    confirmIcon.dataset.champNo = champ_no;
                    mettreAJourIconeConfirmation(confirmIcon, data.est_confirme);
                    cellConfirme.appendChild(confirmIcon);
                });
            }
        }
    </script>

    <!-- Script de gestion du thème -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitcher = document.querySelector('.theme-switcher');
            if (themeSwitcher) {
                const themeButtons = themeSwitcher.querySelectorAll('button');
                function applyThemeUI(theme) {
                    document.documentElement.className = `theme-${theme}`;
                    themeButtons.forEach(btn => btn.classList.remove('active'));
                    const activeButton = document.getElementById(`theme-btn-${theme}`);
                    if (activeButton) activeButton.classList.add('active');
                }
                themeSwitcher.addEventListener('click', function(event) {
                    if (event.target.tagName === 'BUTTON') {
                        const theme = event.target.dataset.theme;
                        localStorage.setItem('appTheme', theme);
                        applyThemeUI(theme);
                    }
                });
                const savedTheme = localStorage.getItem('appTheme') || 'light';
                applyThemeUI(savedTheme);
            }
        });
    </script>
</body>
</html>