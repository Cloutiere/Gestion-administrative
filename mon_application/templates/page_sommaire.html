<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sommaire global des tâches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Script pour appliquer le thème instantanément et éviter le FOUC (Flash of Unstyled Content) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('appTheme') || 'light';
            document.documentElement.className = `theme-${savedTheme}`;
        })();
    </script>
</head>
<body class="theme-light">
    <header>
        <h1>
            Sommaire global des tâches
            {% if annee_active %}
                <span class="annee-active-header">(Année : {{ annee_active.libelle_annee }})</span>
            {% endif %}
        </h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('views.index') }}">« Retour à la navigation par champ</a></li>
                {% if current_user.is_authenticated and current_user.is_admin %}
                    <li><a href="{{ url_for('admin.page_administration_donnees') }}">Administration (Données)</a></li>
                    <li><a href="{{ url_for('admin.page_administration_utilisateurs') }}">Administration (Utilisateurs)</a></li>
                {% endif %}
                {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('auth.logout') }}">Déconnexion ({{ current_user.username }})</a></li>
                {% else %}
                    <li><a href="{{ url_for('auth.login') }}">Connexion</a></li>
                {% endif %}
            </ul>
        </nav>

        <!-- Sélecteur d'année pour l'administrateur -->
        {% if current_user.is_admin and toutes_les_annees %}
        <div class="year-switcher no-print">
            <label for="annee-selector">Changer l'année de visualisation :</label>
            <select id="annee-selector">
                {% for annee in toutes_les_annees %}
                    <option value="{{ annee.annee_id }}" {% if annee_active and annee.annee_id == annee_active.annee_id %}selected{% endif %}>
                        {{ annee.libelle_annee }} {% if annee.est_courante %}(Courante){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- Sélecteur de thème -->
        <div class="theme-switcher no-print">
            <button id="theme-btn-light" data-theme="light" title="Activer le thème clair">Clair</button>
            <button id="theme-btn-dark" data-theme="dark" title="Activer le thème sombre">Sombre</button>
            <button id="theme-btn-vintage" data-theme="vintage" title="Activer le thème vintage">Vintage</button>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% if annee_active %}
        <!-- Conteneur principal utilisant flexbox pour les colonnes -->
        <div class="container-principal-sommaire">

            <!-- Colonne de gauche : Moyennes -->
            <div class="colonne-sommaire colonne-gauche">
                <div class="moyenne-generale-contenu">
                    <span>Moyenne générale (temps plein) :</span>
                    <span id="moyenne-generale-etablissement">{{ moyenne_generale | format_periodes }} périodes</span>
                </div>
                <!-- NOUVEL ÉLÉMENT : Affichage de la moyenne préliminaire confirmée -->
                <div class="moyenne-generale-contenu">
                    <span>Préliminaire confirmée :</span>
                    <span id="moyenne-preliminaire-confirmee">{{ moyenne_preliminaire_confirmee | format_periodes }} périodes</span>
                </div>


                <div>
                    <h2>Moyennes par champ (temps plein)</h2>
                    {% if moyennes_par_champ %}
                    <table id="table-moyennes-par-champ">
                        <thead>
                            <tr>
                                <th>N° champ</th>
                                <th>Nom du champ</th>
                                <th>Statut</th>
                                <th>Pér. Dispo.</th>
                                <th>Pér. Choisies</th>
                                <th>Nb. Ens. TP</th>
                                <th>Moyenne</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Le contenu de ce tbody sera trié et inséré par JavaScript. #}
                        </tbody>
                    </table>
                    <p id="aucune-moyenne-champ-message" style="display: none;">Aucune donnée de moyenne par champ disponible.</p>
                    {% else %}
                    <p>Aucune donnée de moyenne par champ disponible pour cette année.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Colonne de droite : Détail des tâches -->
            <div class="colonne-sommaire colonne-droite">
                <h2>Détail des tâches par champ</h2>
                <table id="table-detail-enseignants">
                    <tbody>
                        {# Le contenu sera généré dynamiquement par JavaScript. #}
                    </tbody>
                </table>
                <p id="aucun-enseignant-message" style="display: none;">Aucun enseignant à afficher.</p>
                {# Afficher ce message si la variable initiale est vide OU si elle ne contient aucun enseignant réel #}
                {% if not enseignants_par_champ or (enseignants_par_champ | map(attribute='enseignants') | sum(start=[]) | length == 0) %}
                <p>Aucun enseignant à afficher pour cette année.</p>
                {% endif %}
            </div>
        </div>
        {% else %}
            <div class="flash-messages">
                <li class="warning">Aucune année scolaire n'est active. Les données ne peuvent pas être affichées.</li>
            </div>
        {% endif %}
    </main>

    <footer>
        <p>© {{ SCRIPT_YEAR }} Votre École</p>
    </footer>

    <!-- Script JS spécifique à la page sommaire -->
    <script>
        const INTERVAL_MISE_A_JOUR = 7000;
        const IS_ADMIN = {{ current_user.is_admin | tojson }};

        // --- Fonctions utilitaires et constantes SVG ---
        function formatPeriodes(value) {
            if (value === null || value === undefined) return '';
            const formatter = new Intl.NumberFormat('fr-CA', { minimumFractionDigits: 0, maximumFractionDigits: 2, useGrouping: false });
            return formatter.format(value);
        }
        const SVG_LOCKED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>`;
        const SVG_UNLOCKED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>`;
        const SVG_CALCULATOR_SLASH = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.35 1.95L1 3.3l4.35 4.35H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c.45 0 .85-.15 1.2-.4L19.7 22.3l1.4-1.4L2.35 1.95zM8 18H6v-2h2v2zm0-4H6v-2h2v2zm4 4H10v-2h2v2zm0-4H10v-2h2v2zm4 4h-2v-2h2v2zM19 3H9v.35L11.65 6H19v12.35l2 2V5c0-1.1-.9-2-2-2zm-4 8h-2v-2h2v2zm-4-4H9v-2h2v2z"/></svg>`;

        document.addEventListener('DOMContentLoaded', function() {
            // Ne démarrer la logique que si une année est active
            {% if annee_active %}
                mettreAJourDonneesSommaire();
                setInterval(mettreAJourDonneesSommaire, INTERVAL_MISE_A_JOUR);

                const tableMoyennes = document.getElementById('table-moyennes-par-champ');
                if (tableMoyennes) {
                    tableMoyennes.addEventListener('click', function(event) {
                        const iconElement = event.target.closest('.lock-icon');
                        if (iconElement && IS_ADMIN) {
                            basculerVerrouChamp(iconElement.dataset.champNo, iconElement);
                        } else if (iconElement) {
                            alert("Vous n'avez pas les permissions pour modifier le statut de verrouillage.");
                        }
                    });
                }
            {% endif %}

            // Logique du sélecteur d'année
            const anneeSelector = document.getElementById('annee-selector');
            if (anneeSelector) {
                anneeSelector.addEventListener('change', function() {
                    const anneeId = this.value;
                    fetch("{{ url_for('admin.api_changer_annee_active') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ annee_id: parseInt(anneeId, 10) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert("Erreur lors du changement d'année de visualisation.");
                        }
                    })
                    .catch(error => {
                        console.error("Erreur de communication pour changer l'année:", error);
                        alert("Erreur de communication avec le serveur.");
                    });
                });
            }
        });

        // --- Fonctions de mise à jour de l'interface ---

        async function mettreAJourDonneesSommaire() {
            try {
                const response = await fetch("{{ url_for('admin.api_get_donnees_sommaire') }}");
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) { window.location.reload(); return; }
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();
                mettreAJourTableauMoyennesChamp(data.moyennes_par_champ || {});
                mettreAJourTableauEnseignantsGroupes(data.enseignants_par_champ || []);

                const elMoyenneGenerale = document.getElementById('moyenne-generale-etablissement');
                if (elMoyenneGenerale) {
                    elMoyenneGenerale.textContent = (data.moyenne_generale !== undefined && data.moyenne_generale !== null)
                        ? `${formatPeriodes(data.moyenne_generale)} périodes`
                        : `N/A périodes`;
                }
                // MISE À JOUR : Mettre à jour la nouvelle moyenne
                const elMoyennePrelim = document.getElementById('moyenne-preliminaire-confirmee');
                if (elMoyennePrelim) {
                    elMoyennePrelim.textContent = (data.moyenne_preliminaire_confirmee !== undefined && data.moyenne_preliminaire_confirmee !== null)
                        ? `${formatPeriodes(data.moyenne_preliminaire_confirmee)} périodes`
                        : `N/A périodes`;
                }
            } catch (error) {
                console.error("Erreur lors de la mise à jour du sommaire:", error);
            }
        }

        async function basculerVerrouChamp(champNo, iconElement) {
            iconElement.style.opacity = '0.5';
            try {
                const response = await fetch(`/admin/api/champs/${champNo}/basculer_verrou`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.message || 'Erreur lors du changement de statut du verrou.');
                await mettreAJourDonneesSommaire();
            } catch (error) {
                console.error(`Erreur bascule verrou pour champ ${champNo}:`, error);
                alert(error.message);
            } finally {
                iconElement.style.opacity = '1';
            }
        }

        function mettreAJourIconeVerrou(iconElement, estVerrouille) {
            iconElement.className = estVerrouille ? 'lock-icon locked' : 'lock-icon unlocked';
            iconElement.innerHTML = estVerrouille ? SVG_LOCKED : SVG_UNLOCKED;
            iconElement.title = estVerrouille ? 'Champ verrouillé. Cliquer pour déverrouiller.' : 'Champ déverrouillé. Cliquer pour verrouiller.';
        }

        function mettreAJourTableauEnseignantsGroupes(enseignantsParChampData) {
            const tbody = document.querySelector('#table-detail-enseignants tbody');
            const aucunEnseignantMsg = document.getElementById('aucun-enseignant-message');
            const table = document.getElementById('table-detail-enseignants');
            if (!tbody || !aucunEnseignantMsg || !table) return;

            tbody.innerHTML = '';
            const aDesEnseignants = enseignantsParChampData.some(c => c.enseignants && c.enseignants.length > 0);

            aucunEnseignantMsg.style.display = aDesEnseignants ? 'none' : 'block';
            table.style.display = aDesEnseignants ? '' : 'none';

            if (aDesEnseignants) {
                enseignantsParChampData.forEach(champData => {
                    if (!champData.enseignants || champData.enseignants.length === 0) return;

                    const champHeaderRow = tbody.insertRow();
                    champHeaderRow.className = 'champ-header-row';
                    const champTitleCell = champHeaderRow.insertCell();
                    champTitleCell.colSpan = 5;
                    champTitleCell.className = 'champ-title-cell';
                    champTitleCell.textContent = `Champ ${champData.champno} - ${champData.champnom}`;

                    const columnHeaderRow = tbody.insertRow();
                    columnHeaderRow.className = 'column-header-row';
                    ['Nom', 'Pér. cours', 'Pér. autres', 'Total pér.', 'Compte moyenne'].forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        columnHeaderRow.appendChild(th);
                    });

                    champData.enseignants.forEach(ens => {
                        const row = tbody.insertRow();
                        row.dataset.enseignantId = ens.enseignantid;
                        row.insertCell().textContent = (ens.nom && ens.prenom) ? `${ens.nom}, ${ens.prenom}` : ens.nomcomplet;
                        row.insertCell().textContent = formatPeriodes(ens.periodes_cours);
                        row.insertCell().textContent = formatPeriodes(ens.periodes_autres);
                        row.insertCell().textContent = formatPeriodes(ens.total_periodes);
                        const cellCompteMoyenne = row.insertCell();
                        if (ens.compte_pour_moyenne_champ) {
                            cellCompteMoyenne.textContent = 'Oui';
                        } else {
                            let nonCompteText = 'Non';
                            if (ens.estfictif) nonCompteText += ' (Tâche restante)';
                            else if (!ens.esttempsplein) nonCompteText += ' (T. Partiel)';
                            cellCompteMoyenne.innerHTML = `<span class="statut-non-compte">${nonCompteText}</span>`;
                        }
                    });
                });
            }
        }

        function comparerNumerosChamp(a, b) {
            const regex = /^(\d+)([a-zA-Z]*)$/;
            const matchA = a.match(regex);
            const matchB = b.match(regex);

            if (matchA && matchB) {
                const numA = parseInt(matchA[1], 10);
                const letterA = matchA[2] || '';
                const numB = parseInt(matchB[1], 10);
                const letterB = matchB[2] || '';

                if (numA !== numB) return numA - numB;
                return letterA.localeCompare(letterB);
            }
            return a.localeCompare(b);
        }

        function mettreAJourTableauMoyennesChamp(moyennesChampData) {
            const tbody = document.querySelector('#table-moyennes-par-champ tbody');
            const aucuneMoyenneMsg = document.getElementById('aucune-moyenne-champ-message');
            const table = document.getElementById('table-moyennes-par-champ');
            if (!tbody || !aucuneMoyenneMsg || !table) return;

            tbody.innerHTML = '';
            const champNosTries = Object.keys(moyennesChampData).sort(comparerNumerosChamp);

            aucuneMoyenneMsg.style.display = champNosTries.length > 0 ? 'none' : 'block';
            table.style.display = champNosTries.length > 0 ? '' : 'none';

            if (champNosTries.length > 0) {
                champNosTries.forEach(champ_no => {
                    const data = moyennesChampData[champ_no];
                    const row = tbody.insertRow();
                    row.dataset.champNo = champ_no;

                    // Création des cellules dans le nouvel ordre
                    row.insertCell().textContent = champ_no;
                    row.insertCell().textContent = data.champ_nom;

                    const cellStatut = row.insertCell();
                    const icon = document.createElement('span');
                    icon.className = 'lock-icon';
                    icon.dataset.champNo = champ_no;
                    mettreAJourIconeVerrou(icon, data.est_verrouille);
                    cellStatut.appendChild(icon);

                    row.insertCell().textContent = formatPeriodes(data.periodes_disponibles);

                    const cellPeriodesChoisies = row.insertCell();
                    if (data.est_verrouille) {
                        cellPeriodesChoisies.textContent = formatPeriodes(data.periodes_choisies);
                    } else {
                        cellPeriodesChoisies.innerHTML = `<span class="icon-cell" title="Total visible uniquement quand le champ est verrouillé">${SVG_CALCULATOR_SLASH}</span>`;
                    }

                    row.insertCell().textContent = data.nb_enseignants_tp;

                    const cellMoyenne = row.insertCell();
                    if (data.est_verrouille) {
                        cellMoyenne.textContent = formatPeriodes(data.moyenne);
                    } else {
                        cellMoyenne.innerHTML = `<span class="icon-cell" title="Moyenne visible uniquement quand le champ est verrouillé">${SVG_CALCULATOR_SLASH}</span>`;
                    }
                });
            }
        }
    </script>

    <!-- Script de gestion du thème -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitcher = document.querySelector('.theme-switcher');
            if (themeSwitcher) {
                const themeButtons = themeSwitcher.querySelectorAll('button');
                function applyThemeUI(theme) {
                    document.documentElement.className = `theme-${theme}`;
                    themeButtons.forEach(btn => btn.classList.remove('active'));
                    const activeButton = document.getElementById(`theme-btn-${theme}`);
                    if (activeButton) activeButton.classList.add('active');
                }
                themeSwitcher.addEventListener('click', function(event) {
                    if (event.target.tagName === 'BUTTON') {
                        const theme = event.target.dataset.theme;
                        localStorage.setItem('appTheme', theme);
                        applyThemeUI(theme);
                    }
                });
                const savedTheme = localStorage.getItem('appTheme') || 'light';
                applyThemeUI(savedTheme);
            }
        });
    </script>
</body>
</html>