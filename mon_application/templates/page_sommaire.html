{% extends "_layout.html" %}

{% block title %}Tableau de Bord Global{% endblock %}

{% block head_extra %}
<style>
    .champ-confirme {
        font-weight: bold;
    }
    .lock-icon, .confirm-icon {
        display: inline-block;
        vertical-align: middle;
        width: 24px;
        height: 24px;
    }
    .lock-icon.admin-only, .confirm-icon.admin-only {
        cursor: pointer;
    }
    .confirm-icon.confirmed path {
        fill: green;
    }
    .confirm-icon.unconfirmed path {
        fill: #ccc;
    }
    .details-link-container {
        display: flex; /* Utilise flexbox pour aligner les éléments */
        justify-content: flex-end; /* Aligne les éléments à droite */
        gap: 1rem; /* Espace entre les boutons */
        margin-bottom: 1rem;
        flex-wrap: wrap; /* Permet aux boutons de passer à la ligne sur petits écrans */
    }

    /* Styles pour le solde final */
    .solde-positif {
        color: green;
        font-weight: bold;
    }
    .solde-negatif {
        color: red;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block header_content %}
<h1>
    Tableau de Bord Global
    {% if annee_active %}
        <span class="annee-active-header">(Année : {{ annee_active.libelle_annee }})</span>
    {% endif %}
</h1>
<nav>
    <ul>
        {% if current_user.is_authenticated %}
            {% if current_user.is_admin %}
                <li><a href="{{ url_for('dashboard.page_sommaire') }}">Tableau de Bord</a></li>
                <li><a href="{{ url_for('admin.page_administration_donnees') }}">Administration (Données)</a></li>
                <li><a href="{{ url_for('admin.page_administration_utilisateurs') }}">Administration (Utilisateurs)</a></li>
            {% elif current_user.is_dashboard_only %}
                <li><a href="{{ url_for('dashboard.page_sommaire') }}">Tableau de Bord</a></li>
                <li><a href="{{ url_for('dashboard.page_detail_taches') }}">Détail des Tâches</a></li>
            {% else %}
                 <li><a href="{{ url_for('views.index') }}">Navigation par champ</a></li>
            {% endif %}
            <li><a href="{{ url_for('auth.logout') }}">Déconnexion ({{ current_user.username }})</a></li>
        {% else %}
            <li><a href="{{ url_for('auth.login') }}">Connexion</a></li>
        {% endif %}
    </ul>
</nav>

<!-- Sélecteur d'année pour l'administrateur ou l'observateur -->
{% if current_user.is_authenticated and (current_user.is_admin or current_user.is_dashboard_only) and toutes_les_annees %}
<div class="year-switcher no-print">
    <label for="annee-selector">Changer l'année de visualisation :</label>
    <select id="annee-selector">
        {% for annee in toutes_les_annees %}
            <option value="{{ annee.annee_id }}" {% if annee_active and annee.annee_id == annee_active.annee_id %}selected{% endif %}>
                {{ annee.libelle_annee }} {% if annee.est_courante %}(Courante){% endif %}
            </option>
        {% endfor %}
    </select>
</div>
{% endif %}
{% endblock %}

{% block content %}
{% if annee_active %}
<!-- Conteneur principal simplifié -->
<div class="container-principal-sommaire">
    <!-- Colonne unique pour les moyennes -->
    <div class="colonne-sommaire colonne-gauche" style="width: 100%; margin: auto; max-width: 1200px;">
        <div class="moyenne-generale-contenu">
            <span>Moyenne générale incluant tous les champs :</span>
            <span id="moyenne-generale-etablissement">{{ moyenne_generale | format_periodes }} périodes</span>
        </div>
        <div class="moyenne-generale-contenu">
            <span>Moyenne générale avec les champs confirmés :</span>
            <span id="moyenne-preliminaire-confirmee">{{ moyenne_preliminaire_confirmee | format_periodes }} périodes</span>
        </div>

        <div>
            <h2>Moyennes par champ (temps plein)</h2>

            <!-- Liens d'action avec les classes de bouton standardisées -->
            <div class="details-link-container no-print">
                <a href="{{ url_for('dashboard.page_detail_taches') }}" class="btn btn-primary">Voir le détail des tâches</a>
                <a href="{{ url_for('dashboard.exporter_taches_excel') }}" class="btn btn-export-excel">Exporter les tâches (Excel)</a>
                <a href="{{ url_for('dashboard.exporter_periodes_restantes_excel') }}" class="btn btn-export-excel">Exporter les périodes restantes (Excel)</a>
                <a href="{{ url_for('dashboard.exporter_org_scolaire_excel') }}" class="btn btn-export-excel">Exporter pour org. scolaire (Excel)</a>
            </div>

            {% if moyennes_par_champ %}
            <table id="table-moyennes-par-champ">
                <thead>
                    <tr>
                        <th>N° champ</th>
                        <th>Nom du champ</th>
                        <th>Verrou</th>
                        <th>Nb. Ens. TP</th>
                        <th>Périodes Choisies (TP)</th>
                        <th>Moyenne</th>
                        <th>Diff. / 24p</th>
                        <th>Confirmé</th>
                        <th>Diff. Confirmé</th>
                    </tr>
                </thead>
                <tbody>
                    {# Le contenu de ce tbody sera trié et inséré par JavaScript. #}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL</td>
                        <td id="total-enseignants-tp" style="font-weight: bold;"></td>
                        <td id="total-periodes-choisies-tp" style="font-weight: bold;"></td>
                        <td></td> <!-- Cellule vide pour la colonne moyenne -->
                        <td></td> <!-- Cellule vide pour le total de "Diff. / 24p" -->
                        <td></td> <!-- Cellule vide pour la colonne Confirmé -->
                        <td id="total-periodes-confirmees-magiques" style="font-weight: bold;"></td>
                    </tr>
                    <tr>
                        <td colspan="8" style="text-align: right; font-weight: bold;">Chiffre magique (Nb Ens. TP * 0.6)</td>
                        <td id="valeur-chiffre-magique" style="font-weight: bold;"></td>
                    </tr>
                     <tr>
                        <td colspan="8" style="text-align: right; font-weight: bold;">Solde Final (Diff. Confirmé - Chiffre Magique)</td>
                        <td id="valeur-solde-final"></td>
                    </tr>
                </tfoot>
            </table>
            <p id="aucune-moyenne-champ-message" style="display: none;">Aucune donnée de moyenne par champ disponible.</p>
            {% else %}
            <p>Aucune donnée de moyenne par champ disponible pour cette année.</p>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
    <div class="flash-messages">
        <li class="warning">Aucune année scolaire n'est active. Les données ne peuvent pas être affichées.</li>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Passerelle de données de Jinja2 vers JavaScript -->
<script>
    const PAGE_DATA = {
        IS_ADMIN: {{ current_user.is_admin | tojson }},
        ANNEE_ACTIVE: {{ annee_active is not none | tojson }},
        URLS: {
            API_CHANGER_ANNEE: "{{ url_for('dashboard.api_changer_annee_active') }}",
            API_GET_DONNEES_SOMMAIRE: "{{ url_for('dashboard.api_get_donnees_sommaire') }}"
        }
    };
</script>

<!-- Chargement du script externe spécifique à la page -->
<script src="{{ url_for('static', filename='js/page_sommaire.js') }}" defer></script>
{% endblock %}