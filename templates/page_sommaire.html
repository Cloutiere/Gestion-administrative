<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sommaire global des tâches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles spécifiques pour la page sommaire. Le style.css global s'applique aussi. */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh; 
            margin: 0; 
        }

        header {
            flex-shrink: 0; 
            padding-bottom: 5px; 
        }
        header h1 { 
            margin-top: 10px; 
            margin-bottom: 5px; 
            margin-left: 20px;
            margin-right: 20px;
            font-size: 1.8em; 
        }
        header p { 
            margin-top: 0; 
            margin-bottom: 10px; 
            margin-left: 20px;
            margin-right: 20px;
        }


        .container-principal-sommaire {
            display: flex;
            flex-grow: 1; 
            overflow: hidden; 
            padding: 10px 15px 15px 15px; 
            gap: 15px; 
        }

        .colonne-sommaire {
            display: flex;
            flex-direction: column;
            gap: 15px; 
            overflow-y: auto; 
            padding: 10px; 
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #ffffff;
        }

        .colonne-gauche {
            flex-basis: 35%;
        }

        .colonne-droite {
            flex-basis: 65%;
        }

        .section-sommaire {
            padding: 10px 15px 15px 15px; 
            border: 1px solid #ccc;
            border-radius:5px;
            background-color: #f9f9f9;
        }
        .section-sommaire h2 {
            margin-top: 0; 
            margin-bottom: 10px; 
            font-size: 1.2em; 
        }
        
        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        th { 
            background-color: #e9ecef; 
            padding: 8px; 
            text-align: left; 
            border: 1px solid #ddd;
        }
        td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }

        /* Styles pour la section moyenne générale reformatée */
        .section-moyenne-generale {
            background-color: #e7f3fe; /* Fond bleu clair existant */
            padding: 10px 15px; /* Padding ajusté */
        }
        .moyenne-generale-contenu {
            display: flex; /* Pour aligner le label et la valeur sur une ligne */
            justify-content: space-between; /* Espace entre label et valeur */
            align-items: center; /* Alignement vertical */
            font-size: 1.1em; /* Taille de police pour la ligne */
            font-weight: bold;
        }
        .moyenne-generale-contenu .label {
            margin-right: 10px; /* Espace entre label et valeur */
        }
        .moyenne-generale-contenu .valeur {
            /* Styles spécifiques pour la valeur si nécessaire */
        }


        .statut-non-compte { color: #6c757d; font-style: italic; }
        
        .champ-header-row th.champ-title-cell {
            background-color: #ddeeff; 
            font-size: 1.05em; 
            padding: 8px 10px; 
            text-align: center; 
            font-weight: bold;
        }
        .column-header-row th {
            background-color: #f8f9fa;
            position: sticky; 
            top: 0; 
            z-index: 1; 
            font-size: 0.85em; 
            padding: 6px 8px; 
        }

        footer {
            flex-shrink: 0; 
            text-align: center;
            padding: 10px;
            background-color: #f1f1f1; 
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
        <h1>Sommaire global des tâches des enseignants</h1> 
        <p><a href="{{ url_for('index') }}">« Retour à la navigation par champ</a></p>
    </header>

    <div class="container-principal-sommaire">
        <div class="colonne-sommaire colonne-gauche">
            <!-- Section affichant la moyenne générale (temps plein) - NOUVELLE POSITION ET FORMAT -->
            <section class="section-sommaire section-moyenne-generale">
                <div class="moyenne-generale-contenu">
                    <span class="label">Moyenne générale (temps plein) :</span>
                    <span class="valeur" id="moyenne-generale-etablissement">{{ "%.2f"|format(moyenne_generale) }} périodes</span>
                </div>
            </section>

            <!-- Section affichant les moyennes des périodes par champ -->
            <section class="section-sommaire">
                <h2>Moyennes par champ (temps plein)</h2>
                {% if moyennes_par_champ %}
                <table id="table-moyennes-par-champ">
                    <thead>
                        <tr>
                            <th>N° champ</th>
                            <th>Nom du champ</th>
                            <th>Moyenne périodes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Le contenu sera trié et inséré par JavaScript #}
                    </tbody>
                </table>
                <p id="aucune-moyenne-champ-message" style="display: none;">Aucune donnée de moyenne par champ disponible.</p>
                {% else %}
                <p>Aucune donnée de moyenne par champ disponible initialement.</p>
                {% endif %}
            </section>
        </div>

        <div class="colonne-sommaire colonne-droite">
            <section class="section-sommaire">
                <h2>Détail des tâches par champ</h2>
                <table id="table-detail-enseignants">
                    <tbody>
                        {# Le contenu sera généré par JavaScript #}
                    </tbody>
                </table>
                <p id="aucun-enseignant-message" style="display: none;">Aucun enseignant à afficher.</p>
                {% if not enseignants_par_champ %}
                <p>Aucun enseignant à afficher initialement.</p>
                {% endif %}
            </section>
        </div>
    </div>

    <footer>
        <p>© {{ SCRIPT_YEAR }} Votre École</p>
    </footer>

    <script>
        const INTERVAL_MISE_A_JOUR = 7000; 

        document.addEventListener('DOMContentLoaded', function() {
            mettreAJourDonneesSommaire(); 
            setInterval(mettreAJourDonneesSommaire, INTERVAL_MISE_A_JOUR);
        });

        async function mettreAJourDonneesSommaire() {
            try {
                const response = await fetch('/api/sommaire/donnees');
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();

                if (data.moyennes_par_champ) {
                    mettreAJourTableauMoyennesChamp(data.moyennes_par_champ);
                } else {
                    console.warn("Données 'moyennes_par_champ' non trouvées.");
                    mettreAJourTableauMoyennesChamp({});
                }

                if (data.enseignants_par_champ && Array.isArray(data.enseignants_par_champ)) {
                    mettreAJourTableauEnseignantsGroupes(data.enseignants_par_champ);
                } else {
                    console.warn("Données 'enseignants_par_champ' non trouvées ou invalides.");
                    mettreAJourTableauEnseignantsGroupes([]);
                }

                const elMoyenneGenerale = document.getElementById('moyenne-generale-etablissement');
                if (elMoyenneGenerale && data.moyenne_generale !== undefined) {
                    // Met à jour uniquement la valeur numérique, le texte "périodes" reste dans le HTML
                    elMoyenneGenerale.textContent = `${parseFloat(data.moyenne_generale).toFixed(2)} périodes`;
                } else if (elMoyenneGenerale) {
                    elMoyenneGenerale.textContent = `N/A périodes`;
                }
            } catch (error) {
                console.error("Erreur MàJ sommaire:", error);
            }
        }
        
        function mettreAJourTableauEnseignantsGroupes(enseignantsParChampData) {
            const tbody = document.querySelector('#table-detail-enseignants tbody');
            const aucunEnseignantMsg = document.getElementById('aucun-enseignant-message');
            const tableDetailEnseignants = document.getElementById('table-detail-enseignants');

            if (!tbody) return; 
            tbody.innerHTML = ''; 

            if (enseignantsParChampData && enseignantsParChampData.length > 0) {
                if (aucunEnseignantMsg) aucunEnseignantMsg.style.display = 'none';
                if (tableDetailEnseignants) tableDetailEnseignants.style.display = 'table';

                enseignantsParChampData.forEach(champData => {
                    const champHeaderRow = tbody.insertRow();
                    champHeaderRow.classList.add('champ-header-row');
                    const champTitleCell = document.createElement('th'); 
                    champTitleCell.colSpan = 5; 
                    champTitleCell.classList.add('champ-title-cell');
                    champTitleCell.textContent = `Champ ${champData.champno} - ${champData.champnom}`;
                    champHeaderRow.appendChild(champTitleCell);

                    const columnHeaderRow = tbody.insertRow();
                    columnHeaderRow.classList.add('column-header-row');
                    ['Nom de l\'enseignant', 'Pér. cours', 'Pér. autres', 'Total pér.', 'Compte pour moyenne champ'].forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        columnHeaderRow.appendChild(th);
                    });

                    champData.enseignants.forEach(ens => {
                        const row = tbody.insertRow();
                        row.dataset.enseignantId = ens.enseignantid;
                        row.insertCell().textContent = ens.nomcomplet;
                        row.insertCell().classList.add('periodes-cours');
                        row.cells[1].textContent = ens.periodes_cours;
                        row.insertCell().classList.add('periodes-autres');
                        row.cells[2].textContent = ens.periodes_autres;
                        row.insertCell().classList.add('total-periodes');
                        row.cells[3].textContent = ens.total_periodes;
                        
                        const cellCompteMoyenne = row.insertCell();
                        cellCompteMoyenne.classList.add('compte-moyenne');
                        if (ens.compte_pour_moyenne_champ) {
                            cellCompteMoyenne.textContent = 'Oui';
                        } else {
                            let nonCompteText = 'Non';
                            if (ens.estfictif) nonCompteText += ' (Fictif)';
                            else if (!ens.esttempsplein) nonCompteText += ' (Temps Partiel)';
                            cellCompteMoyenne.innerHTML = `<span class="statut-non-compte">${nonCompteText}</span>`;
                        }
                    });
                });
            } else {
                if (tableDetailEnseignants) tableDetailEnseignants.style.display = 'none';
                if (aucunEnseignantMsg) {
                    aucunEnseignantMsg.style.display = 'block';
                } else {
                    const p = document.createElement('p');
                    p.id = 'aucun-enseignant-message';
                    p.textContent = 'Aucun enseignant à afficher.';
                    const sectionElement = tableDetailEnseignants?.closest('.section-sommaire') || document.body;
                    if (sectionElement) sectionElement.appendChild(p);
                }
            }
        }
        
        function comparerNumerosChamp(a, b) {
            const regex = /^(\d+)([a-zA-Z]*)$/; 
            const matchA = a.match(regex);
            const matchB = b.match(regex);
            if (!matchA || !matchB) { 
                return a.localeCompare(b);
            }
            const numA = parseInt(matchA[1], 10);
            const letterA = matchA[2];
            const numB = parseInt(matchB[1], 10);
            const letterB = matchB[2];
            if (numA !== numB) {
                return numA - numB;
            }
            return letterA.localeCompare(letterB);
        }

        function mettreAJourTableauMoyennesChamp(moyennesChampData) {
            const tbody = document.querySelector('#table-moyennes-par-champ tbody');
            const aucuneMoyenneMsg = document.getElementById('aucune-moyenne-champ-message');
            const tableMoyennesChamp = document.getElementById('table-moyennes-par-champ');

            if (!tbody) return;
            tbody.innerHTML = ''; 
            const champNosTries = Object.keys(moyennesChampData).sort(comparerNumerosChamp);

            if (champNosTries.length > 0) {
                 if (aucuneMoyenneMsg) aucuneMoyenneMsg.style.display = 'none';
                 if (tableMoyennesChamp) tableMoyennesChamp.style.display = 'table';

                champNosTries.forEach(champ_no => { 
                    const data = moyennesChampData[champ_no];
                    const row = tbody.insertRow();
                    row.dataset.champNo = champ_no;
                    row.insertCell().textContent = champ_no;
                    row.insertCell().textContent = data.champ_nom;
                    const cellMoyenne = row.insertCell();
                    cellMoyenne.classList.add('moyenne-periodes');
                    cellMoyenne.textContent = parseFloat(data.moyenne).toFixed(2);
                });
            } else {
                if (tableMoyennesChamp) tableMoyennesChamp.style.display = 'none';
                if (aucuneMoyenneMsg) {
                    aucuneMoyenneMsg.style.display = 'block';
                } else {
                    const pExist = document.getElementById('aucune-moyenne-champ-message');
                    if (!pExist) {
                        const p = document.createElement('p');
                        p.id = 'aucune-moyenne-champ-message';
                        p.textContent = 'Aucune donnée de moyenne par champ disponible.';
                        const sectionElement = tableMoyennesChamp?.closest('.section-sommaire') || document.body;
                        if (sectionElement) sectionElement.appendChild(p);
                    }
                }
            }
        }
    </script>
</body>
</html>