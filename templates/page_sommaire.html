<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sommaire global des tâches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles spécifiques pour la page sommaire. Le style.css global s'applique aussi. */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        header {
            flex-shrink: 0;
            padding-bottom: 5px;
        }
        header h1 {
            margin-top: 10px;
            margin-bottom: 5px;
            margin-left: 20px;
            margin-right: 20px;
            font-size: 1.8em;
        }
        header p {
            margin-top: 0;
            margin-bottom: 10px;
            margin-left: 20px;
            margin-right: 20px;
        }

        .container-principal-sommaire {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 10px 15px 15px 15px;
            gap: 15px;
        }

        .colonne-sommaire {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #ffffff;
        }

        .colonne-gauche {
            flex-basis: 35%;
        }

        .colonne-droite {
            flex-basis: 65%;
        }

        .section-sommaire {
            padding: 10px 15px 15px 15px;
            border: 1px solid #ccc;
            border-radius:5px;
            background-color: #f9f9f9;
        }
        .section-sommaire h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        th {
            background-color: #e9ecef;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #table-moyennes-par-champ th:last-child,
        #table-moyennes-par-champ td:last-child {
            text-align: center;
            vertical-align: middle;
        }

        .section-moyenne-generale {
            background-color: #e7f3fe;
            padding: 10px 15px;
        }
        .moyenne-generale-contenu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
        }

        .statut-non-compte { color: #6c757d; font-style: italic; }

        .champ-header-row th.champ-title-cell {
            background-color: #ddeeff;
            font-size: 1.05em;
            padding: 8px 10px;
            text-align: center;
            font-weight: bold;
        }
        .column-header-row th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 0.85em;
            padding: 6px 8px;
        }

        /* STYLES POUR LES ICÔNES SVG */
        .lock-icon {
            cursor: pointer;
            display: inline-block;
            width: 20px; /* Taille de l'icône */
            height: 20px;
            transition: transform 0.2s ease-in-out;
        }
        .lock-icon:hover {
            transform: scale(1.15); /* Effet de grossissement au survol */
        }
        .lock-icon svg {
            width: 100%;
            height: 100%;
        }
        .lock-icon.unlocked svg {
            fill: #28a745; /* Vert pour déverrouillé */
        }
        .lock-icon.locked svg {
            fill: #dc3545; /* Rouge pour verrouillé */
        }

        footer {
            flex-shrink: 0;
            text-align: center;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
        <h1>Sommaire global des tâches des enseignants</h1>
        <p><a href="{{ url_for('index') }}">« Retour à la navigation par champ</a></p>
    </header>

    <div class="container-principal-sommaire">
        <div class="colonne-sommaire colonne-gauche">
            <section class="section-sommaire section-moyenne-generale">
                <div class="moyenne-generale-contenu">
                    <span class="label">Moyenne générale (temps plein) :</span>
                    <span class="valeur" id="moyenne-generale-etablissement">{{ "%.2f"|format(moyenne_generale) }} périodes</span>
                </div>
            </section>

            <section class="section-sommaire">
                <h2>Moyennes par champ (temps plein)</h2>
                {% if moyennes_par_champ %}
                <table id="table-moyennes-par-champ">
                    <thead>
                        <tr>
                            <th>N° champ</th>
                            <th>Nom du champ</th>
                            <th>Moyenne</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Le contenu sera trié et inséré par JavaScript #}
                    </tbody>
                </table>
                <p id="aucune-moyenne-champ-message" style="display: none;">Aucune donnée de moyenne par champ disponible.</p>
                {% else %}
                <p>Aucune donnée de moyenne par champ disponible initialement.</p>
                {% endif %}
            </section>
        </div>

        <div class="colonne-sommaire colonne-droite">
            <section class="section-sommaire">
                <h2>Détail des tâches par champ</h2>
                <table id="table-detail-enseignants">
                    <tbody>
                        {# Le contenu sera généré par JavaScript #}
                    </tbody>
                </table>
                <p id="aucun-enseignant-message" style="display: none;">Aucun enseignant à afficher.</p>
                {# Affichage initial si pas de données, JavaScript cachera si des données sont chargées #}
                {% if not enseignants_par_champ or not enseignants_par_champ | selectattr('enseignants') | list | join %}
                <p>Aucun enseignant à afficher initialement.</p>
                {% endif %}
            </section>
        </div>
    </div>

    <footer>
        <p>© {{ SCRIPT_YEAR }} Votre École</p>
    </footer>

    <script>
        const INTERVAL_MISE_A_JOUR = 7000;

        // DÉFINITION DES ICÔNES SVG POUR UNE UTILISATION UNIVERSELLE
        const SVG_LOCKED = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
            </svg>`;
        const SVG_UNLOCKED = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
            </svg>`;


        document.addEventListener('DOMContentLoaded', function() {
            mettreAJourDonneesSommaire();
            setInterval(mettreAJourDonneesSommaire, INTERVAL_MISE_A_JOUR);

            const tableMoyennes = document.getElementById('table-moyennes-par-champ');
            if(tableMoyennes) {
                tableMoyennes.addEventListener('click', function(event) {
                    const iconElement = event.target.closest('.lock-icon');
                    if (iconElement) {
                        const champNo = iconElement.dataset.champNo;
                        basculerVerrouChamp(champNo, iconElement);
                    }
                });
            }
        });

        async function mettreAJourDonneesSommaire() {
            try {
                const response = await fetch('/api/sommaire/donnees');
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();

                if (data.moyennes_par_champ) {
                    mettreAJourTableauMoyennesChamp(data.moyennes_par_champ);
                } else {
                    console.warn("Données 'moyennes_par_champ' non trouvées.");
                    mettreAJourTableauMoyennesChamp({}); // Passer un objet vide pour vider le tableau
                }

                // Vérifier si enseignants_par_champ existe et a au moins un champ avec des enseignants
                const aDesEnseignants = data.enseignants_par_champ && data.enseignants_par_champ.some(champ => champ.enseignants && champ.enseignants.length > 0);
                if (aDesEnseignants) {
                    mettreAJourTableauEnseignantsGroupes(data.enseignants_par_champ);
                } else {
                     console.warn("Données 'enseignants_par_champ' non trouvées ou vides.");
                    mettreAJourTableauEnseignantsGroupes([]); // Passer un tableau vide pour vider le tableau
                }


                const elMoyenneGenerale = document.getElementById('moyenne-generale-etablissement');
                if (elMoyenneGenerale) {
                    if (data.moyenne_generale !== undefined && data.moyenne_generale !== null) {
                        elMoyenneGenerale.textContent = `${parseFloat(data.moyenne_generale).toFixed(2)} périodes`;
                    } else {
                        elMoyenneGenerale.textContent = `N/A périodes`;
                    }
                }
            } catch (error) {
                console.error("Erreur MàJ sommaire:", error);
                // Optionnel: Afficher une notification à l'utilisateur ici
            }
        }

        async function basculerVerrouChamp(champNo, iconElement) {
            iconElement.style.opacity = '0.5'; // Indication visuelle de l'action en cours
            try {
                const response = await fetch(`/api/champs/${champNo}/basculer_verrou`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erreur lors du changement de statut du verrou.');
                }
                mettreAJourIconeVerrou(iconElement, data.est_verrouille);
            } catch (error) {
                console.error(`Erreur bascule verrou pour champ ${champNo}:`, error);
                alert(error.message); // Ou une notification plus discrète
            } finally {
                iconElement.style.opacity = '1';
            }
        }

        /**
         * Met à jour l'icône de verrouillage SVG en fonction de son état.
         * @param {HTMLElement} iconElement - L'élément conteneur de l'icône à mettre à jour.
         * @param {boolean} estVerrouille - True si le champ est verrouillé, sinon false.
         */
        function mettreAJourIconeVerrou(iconElement, estVerrouille) {
            if (estVerrouille) {
                iconElement.classList.remove('unlocked');
                iconElement.classList.add('locked');
                iconElement.innerHTML = SVG_LOCKED;
                iconElement.title = 'Champ verrouillé. Cliquer pour déverrouiller.';
            } else {
                iconElement.classList.remove('locked');
                iconElement.classList.add('unlocked');
                iconElement.innerHTML = SVG_UNLOCKED;
                iconElement.title = 'Champ déverrouillé. Cliquer pour verrouiller.';
            }
        }

        function mettreAJourTableauEnseignantsGroupes(enseignantsParChampData) {
            const tbody = document.querySelector('#table-detail-enseignants tbody');
            const aucunEnseignantMsg = document.getElementById('aucun-enseignant-message');
            const tableDetailEnseignants = document.getElementById('table-detail-enseignants');

            if (!tbody) return;
            tbody.innerHTML = ''; // Vider le contenu précédent

            if (enseignantsParChampData && enseignantsParChampData.length > 0 && enseignantsParChampData.some(champ => champ.enseignants && champ.enseignants.length > 0)) {
                if (aucunEnseignantMsg) aucunEnseignantMsg.style.display = 'none';
                if (tableDetailEnseignants) tableDetailEnseignants.style.display = 'table';

                enseignantsParChampData.forEach(champData => {
                    // Ne pas afficher un champ s'il n'a pas d'enseignants
                    if (!champData.enseignants || champData.enseignants.length === 0) {
                        return;
                    }

                    const champHeaderRow = tbody.insertRow();
                    champHeaderRow.classList.add('champ-header-row');
                    const champTitleCell = document.createElement('th');
                    champTitleCell.colSpan = 5; // Nom, Pér. cours, Pér. autres, Total pér., Compte moyenne
                    champTitleCell.classList.add('champ-title-cell');
                    champTitleCell.textContent = `Champ ${champData.champno} - ${champData.champnom}`;
                    champHeaderRow.appendChild(champTitleCell);

                    const columnHeaderRow = tbody.insertRow();
                    columnHeaderRow.classList.add('column-header-row');
                    ['Nom', 'Pér. cours', 'Pér. autres', 'Total pér.', 'Compte moyenne'].forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        columnHeaderRow.appendChild(th);
                    });

                    // Les enseignants sont déjà triés par Nom, Prénom par le backend (via get_all_enseignants_avec_details)
                    champData.enseignants.forEach(ens => {
                        const row = tbody.insertRow();
                        row.dataset.enseignantId = ens.enseignantid;

                        // Affichage Nom, Prénom ou NomComplet
                        const nomCell = row.insertCell();
                        if (ens.nom && ens.prenom) {
                            nomCell.textContent = `${ens.nom}, ${ens.prenom}`;
                        } else {
                            nomCell.textContent = ens.nomcomplet; // Pour les tâches fictives
                        }

                        row.insertCell().textContent = ens.periodes_cours;
                        row.insertCell().textContent = ens.periodes_autres;
                        row.insertCell().textContent = ens.total_periodes;

                        const cellCompteMoyenne = row.insertCell();
                        if (ens.compte_pour_moyenne_champ) {
                            cellCompteMoyenne.textContent = 'Oui';
                        } else {
                            let nonCompteText = 'Non';
                            if (ens.estfictif) nonCompteText += ' (Tâche restante)';
                            else if (!ens.esttempsplein) nonCompteText += ' (T. Partiel)';
                            cellCompteMoyenne.innerHTML = `<span class="statut-non-compte">${nonCompteText}</span>`;
                        }
                    });
                });
            } else {
                if (tableDetailEnseignants) tableDetailEnseignants.style.display = 'none';
                if (aucunEnseignantMsg) aucunEnseignantMsg.style.display = 'block';
            }
        }

        function comparerNumerosChamp(a, b) {
            const regex = /^(\d+)([a-zA-Z]*)$/;
            const matchA = a.match(regex);
            const matchB = b.match(regex);
            if (!matchA || !matchB) {
                return a.localeCompare(b); // Fallback pour les formats non numériques
            }
            const numA = parseInt(matchA[1], 10);
            const letterA = matchA[2];
            const numB = parseInt(matchB[1], 10);
            const letterB = matchB[2];
            if (numA !== numB) {
                return numA - numB;
            }
            return letterA.localeCompare(letterB); // Comparer les parties littérales si les nombres sont égaux
        }

        function mettreAJourTableauMoyennesChamp(moyennesChampData) {
            const tbody = document.querySelector('#table-moyennes-par-champ tbody');
            const aucuneMoyenneMsg = document.getElementById('aucune-moyenne-champ-message');
            const tableMoyennesChamp = document.getElementById('table-moyennes-par-champ');

            if (!tbody) return;
            tbody.innerHTML = ''; // Vider le contenu précédent
            const champNosTries = Object.keys(moyennesChampData).sort(comparerNumerosChamp);

            if (champNosTries.length > 0) {
                 if (aucuneMoyenneMsg) aucuneMoyenneMsg.style.display = 'none';
                 if (tableMoyennesChamp) tableMoyennesChamp.style.display = 'table';

                champNosTries.forEach(champ_no => {
                    const data = moyennesChampData[champ_no];
                    const row = tbody.insertRow();
                    row.dataset.champNo = champ_no;
                    row.insertCell().textContent = champ_no;
                    row.insertCell().textContent = data.champ_nom;
                    row.insertCell().textContent = parseFloat(data.moyenne).toFixed(2);

                    const cellStatut = row.insertCell();
                    const icon = document.createElement('span');
                    icon.className = 'lock-icon'; // La classe de base
                    icon.dataset.champNo = champ_no;

                    mettreAJourIconeVerrou(icon, data.est_verrouille); // Appelle la fonction pour configurer l'icône

                    cellStatut.appendChild(icon);
                });
            } else {
                if (tableMoyennesChamp) tableMoyennesChamp.style.display = 'none';
                if (aucuneMoyenneMsg) aucuneMoyenneMsg.style.display = 'block';
            }
        }
    </script>
</body>
</html>