 <!DOCTYPE html>
 <html lang="fr">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Administration - Gestion des données</title>
     <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
 </head>
 <body>
     <header>
         <h1>Administration - Gestion des données</h1>
         <nav>
             <ul>
                 <li><a href="{{ url_for('index') }}">Accueil</a></li>
                 {% if current_user.is_authenticated and current_user.is_admin %}
                     <li><a href="{{ url_for('page_sommaire') }}">Sommaire Global</a></li>
                 {% endif %}
                 {% if current_user.is_authenticated %}
                     <li><a href="{{ url_for('logout') }}">Déconnexion ({{ current_user.username }})</a></li>
                 {% else %}
                     <li><a href="{{ url_for('login') }}">Connexion</a></li>
                     <li><a href="{{ url_for('register') }}">S'inscrire</a></li>
                 {% endif %}
             </ul>
         </nav>
     </header>

     <main>
         {% with messages = get_flashed_messages(with_categories=true) %}
             {% if messages %}
                 <ul class="flash-messages">
                 {% for category, message in messages %}
                     <li class="{{ category }}">{{ message }}</li>
                 {% endfor %}
                 </ul>
             {% endif %}
         {% endwith %}

         <!-- Section pour l'importation des ENSEIGNANTS via Excel -->
         <section class="admin-section">
             <h2>Importer des Enseignants depuis un Fichier Excel</h2>
             <form method="POST" action="{{ url_for('api_importer_enseignants_excel') }}" enctype="multipart/form-data">
                 <div>
                     <label for="fichier_enseignants">Sélectionner un fichier Excel (.xlsx) :</label>
                     <input type="file" id="fichier_enseignants" name="fichier_enseignants" accept=".xlsx" required>
                 </div>
                 <button type="submit" class="btn-importer">Importer les Enseignants</button>
             </form>
             <div class="note-importation">
                 <p>Le fichier Excel doit respecter le format suivant :</p>
                 <ul>
                     <li>Colonne A : Champ (Numéro du champ, ex: 01)</li>
                     <li>Colonne B : NOM (Nom de famille de l'enseignant)</li>
                     <li>Colonne C : PRÉNOM (Prénom de l'enseignant)</li>
                     <li>Colonne D : Temps plein (VRAI ou FAUX)</li>
                 </ul>
                 <p>
                     Les colonnes `EstFictif` et `PeutChoisirHorsChampPrincipal` seront initialisées à `FAUX` pour tous les enseignants importés.
                     La première ligne du fichier est considérée comme une ligne d'en-têtes et sera ignorée.
                 </p>
                 <p class="warning-text">
                     ATTENTION : L'importation écrasera TOUS les enseignants et TOUTES les attributions de cours existants dans la base de données.
                 </p>
             </div>
         </section>

         <hr>

         <!-- Section pour l'importation des COURS via Excel -->
         <section class="admin-section">
             <h2>Importer des Cours depuis un Fichier Excel</h2>
             <form method="POST" action="{{ url_for('api_importer_cours_excel') }}" enctype="multipart/form-data">
                 <div>
                     <label for="fichier_cours">Sélectionner un fichier Excel (.xlsx) :</label>
                     <input type="file" id="fichier_cours" name="fichier_cours" accept=".xlsx" required>
                 </div>
                 <button type="submit" class="btn-importer">Importer les Cours</button>
             </form>
             <div class="note-importation">
                 <p>Le fichier Excel doit respecter le format suivant :</p>
                 <ul>
                     <li>Colonne A : Champ (Numéro du champ)</li>
                     <li>Colonne B : Code Cours</li>
                     <li>Colonne C : Grille (Ignorée)</li>
                     <li>Colonne D : Cours (Descriptif)</li>
                     <li>Colonne E : Groupes prévus</li>
                     <li>Colonne F : Périodes par cycle</li>
                     <li>Colonne G : Total période (Ignoré)</li>
                     <li>Colonne H : Cours Autre (VRAI ou FAUX)</li>
                 </ul>
                 <p>La première ligne du fichier est considérée comme une ligne d'en-têtes et sera ignorée.</p>
                 <p class="warning-text">
                     ATTENTION : L'importation écrasera TOUS les cours et TOUTES les attributions de cours existants.
                 </p>
             </div>
         </section>

         <hr>

         <!-- Section existante pour la réassignation des cours -->
         <section class="admin-section">
             <h2>Réassigner un Cours à un Champ</h2>
             <div id="message-container-reassign" class="message-area"></div>
             {% if cours_a_reassigner and champs_destination %}
                 <table>
                     <thead>
                         <tr>
                             <th>Code Cours</th>
                             <th>Descriptif</th>
                             <th>Champ Actuel (No)</th>
                             <th>Champ Actuel (Nom)</th>
                             <th>Nouveau Champ</th>
                             <th>Action</th>
                         </tr>
                     </thead>
                     <tbody>
                         {% for cours in cours_a_reassigner %}
                         <tr id="cours-row-{{ cours.codecours }}">
                             <td>{{ cours.codecours }}</td>
                             <td>{{ cours.coursdescriptif }}</td>
                             <td class="champ-actuel-no" data-champno="{{ cours.champno }}">{{ cours.champno }}</td>
                             <td class="champ-actuel-nom">{{ cours.champnom }}</td>
                             <td>
                                 <select id="select-champ-{{ cours.codecours }}" class="select-champ" data-codecours="{{ cours.codecours }}">
                                     <option value="">-- Sélectionner un nouveau champ --</option>
                                     {% for champ_dest in champs_destination %}
                                         {% if champ_dest.champno != cours.champno %}
                                             <option value="{{ champ_dest.champno }}">{{ champ_dest.champnom }} ({{ champ_dest.champno }})</option>
                                         {% endif %}
                                     {% endfor %}
                                 </select>
                             </td>
                             <td>
                                 <button class="btn-reassigner" data-codecours="{{ cours.codecours }}">Réassigner</button>
                             </td>
                         </tr>
                         {% endfor %}
                     </tbody>
                 </table>
             {% elif not cours_a_reassigner %}
                 <p>Aucun cours n'a été trouvé dans la base de données pour la réassignation.</p>
             {% elif not champs_destination %}
                 <p>Aucun champ de destination n'a été trouvé. Impossible de réassigner les cours.</p>
             {% else %}
                 <p>Un problème est survenu lors du chargement des données pour la réassignation.</p>
             {% endif %}
         </section>
     </main>

     <footer>
         <p>© {{ SCRIPT_YEAR }} Votre Application de Gestion</p>
     </footer>

     <script>
         document.addEventListener('DOMContentLoaded', function() {
             const messageContainerReassign = document.getElementById('message-container-reassign');
             const champsDestinationData = JSON.parse('{{ champs_destination | tojson | safe }}');

             document.querySelectorAll('.btn-reassigner').forEach(button => {
                 button.addEventListener('click', function() {
                     const codeCours = this.dataset.codecours;
                     const selectElement = document.getElementById(`select-champ-${codeCours}`);
                     const nouveauChampNo = selectElement.value;
                     const ancienChampNoCell = document.querySelector(`#cours-row-${codeCours} .champ-actuel-no`);
                     const ancienChampNo = ancienChampNoCell.dataset.champno;

                     if (!nouveauChampNo) {
                         displayReassignMessage('Veuillez sélectionner un nouveau champ de destination.', 'error');
                         return;
                     }

                     if (nouveauChampNo === ancienChampNo) {
                          displayReassignMessage('Le cours est déjà assigné à ce champ. Aucune action effectuée.', 'info');
                         return;
                     }

                     const nomCoursEl = document.querySelector(`#cours-row-${codeCours} td:nth-child(2)`);
                     const nomCours = nomCoursEl ? nomCoursEl.textContent : "Inconnu";
                     const nomNouveauChamp = selectElement.options[selectElement.selectedIndex].text;

                     if (!confirm(`Êtes-vous sûr de vouloir réassigner le cours "${nomCours}" (${codeCours}) au champ "${nomNouveauChamp}" ?`)) {
                         return;
                     }

                     this.disabled = true;

                     fetch('/api/cours/reassigner_champ', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             code_cours: codeCours,
                             nouveau_champ_no: nouveauChampNo
                         })
                     })
                     .then(response => response.json())
                     .then(data => {
                         if (data.success) {
                             displayReassignMessage(data.message, 'success');
                             const row = document.getElementById(`cours-row-${codeCours}`);
                             const champNoCell = row.querySelector('.champ-actuel-no');
                             const champNomCell = row.querySelector('.champ-actuel-nom');

                             champNoCell.textContent = data.nouveau_champ_no;
                             champNomCell.textContent = data.nouveau_champ_nom;
                             champNoCell.dataset.champno = data.nouveau_champ_no;

                             updateSelectOptions(selectElement, data.nouveau_champ_no, ancienChampNo);
                         } else {
                             let errorMessage = data.message || 'Une erreur est survenue lors de la réassignation.';
                             displayReassignMessage(errorMessage, 'error');
                         }
                     })
                     .catch(error => {
                         console.error('Erreur lors de la réassignation:', error);
                         displayReassignMessage('Erreur de communication avec le serveur.', 'error');
                     })
                     .finally(() => {
                         this.disabled = false;
                     });
                 });
             });

             function displayReassignMessage(message, type) {
                 messageContainerReassign.textContent = message;
                 messageContainerReassign.className = 'message-area';
                 messageContainerReassign.classList.add(`message-${type}`);
                 messageContainerReassign.style.display = 'block';

                 setTimeout(() => {
                     messageContainerReassign.style.display = 'none';
                 }, 7000);
             }

             function updateSelectOptions(selectElement, nouveauChampNoActuel, ancienChampNoPrecedent) {
                 while (selectElement.options.length > 1) {
                     selectElement.remove(1);
                 }

                 const champPrecedentInfo = champsDestinationData.find(ch => ch.champno === ancienChampNoPrecedent);
                 if (champPrecedentInfo && String(champPrecedentInfo.champno) !== String(nouveauChampNoActuel)) {
                     const optionAncien = document.createElement('option');
                     optionAncien.value = champPrecedentInfo.champno;
                     optionAncien.textContent = `${champPrecedentInfo.champnom} (${champPrecedentInfo.champno})`;
                     selectElement.appendChild(optionAncien);
                 }

                 champsDestinationData.forEach(champ => {
                     if (String(champ.champno) !== String(nouveauChampNoActuel) && String(champ.champno) !== String(ancienChampNoPrecedent)) {
                         const option = document.createElement('option');
                         option.value = champ.champno;
                         option.textContent = `${champ.champnom} (${champ.champno})`;
                         selectElement.appendChild(option);
                     }
                 });
                 selectElement.value = "";
             }
         });
     </script>
 </body>
 </html>