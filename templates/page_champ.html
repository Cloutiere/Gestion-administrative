<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¢ches - Champ {{ champ.champnom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Styles sp√©cifiques pour la page de gestion d'un champ */
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
        }

        .enseignants-section {
            flex: 2;
            min-width: 400px;
            max-height: calc(100vh - 200px); /* Hauteur maximale pour permettre le d√©filement interne */
            overflow-y: auto; /* D√©filement vertical pour la section des enseignants si elle d√©passe la hauteur max */
            padding:10px;
            border: 1px solid #ccc;
            border-radius:5px;
            background-color: #f9f9f9;
        }

        .cours-restants-section, .sommaire-champ-section {
            flex: 1;
            min-width: 300px;
            padding:10px;
            border: 1px solid #ccc;
            border-radius:5px;
            background-color: #f9f9f9;
            max-height: calc(100vh - 200px); /* Hauteur maximale pour ces sections aussi */
            overflow-y: auto; /* Permettre le d√©filement si le contenu est trop grand */
        }

        #lock-status-indicator {
            font-size: 0.8em;
            color: #dc3545;
            margin-left: 10px;
        }

        .enseignant-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            transition: background-color 0.3s ease;
        }

        .enseignant-fictif { background-color: #f0f8ff; border-left: 5px solid #cce5ff; }

        .enseignant-card.detail-visible {
            background-color: #e7f3fe;
            border-left: 5px solid #007bff;
        }

        .entete-enseignant {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .entete-enseignant:hover { background-color: #f0f0f0; }
        .entete-enseignant .arrow-indicator { margin-left: 10px; transition: transform 0.3s ease; }
        .enseignant-card.detail-visible .entete-enseignant .arrow-indicator { transform: rotate(90deg); }

        .entete-enseignant h3.titre-enseignant-bascule { margin-bottom: 5px; }
        .nom-enseignant-texte { flex-grow: 1; }
        .action-enseignant-fictif { text-align: right; margin-top: 0; margin-bottom: 5px; }

        .contenu-selection-cours { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .enseignant-card.detail-visible .contenu-selection-cours { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        div.cours-attribues > table { margin-top: 5px; }

        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background-color: #e9ecef; }

        .sous-titre-cours-restants td, .sous-titre-attributions td {
            background-color: #f0f0f0; font-weight: bold; text-align: center;
            border-top: 2px solid #ccc; border-bottom: 1px solid #ccc;
        }

        .total-attributions-row td { font-weight: bold; background-color: #e9ecef; text-align: right; }
        .total-attributions-row td:first-child { text-align: left; }

        .cours-attribues { margin-top: 0px; }

        .cours-selection button, .btn-retirer-cours, .btn-supprimer-enseignant {
            margin-left:5px; cursor:pointer; padding: 3px 8px; font-size: 0.85em;
        }
        .btn-retirer-cours, .btn-supprimer-enseignant { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .btn-retirer-cours:hover, .btn-supprimer-enseignant:hover { background-color: #f5c6cb;}
        .section-title { margin-top: 20px; margin-bottom:10px; font-size: 1.2em; color: #333; border-bottom: 1px solid #eee; padding-bottom:5px;}

        .cours-selection { margin-top: 15px; }
        .cours-selection ul { list-style-type: none; padding-left: 0; margin-top: 5px; margin-bottom: 5px; }
        .cours-selection li { margin-bottom: 2px; padding: 3px 5px; border-bottom: 1px dashed #eee; }
        .cours-selection li:last-child { border-bottom: none; }

        /* Styles pour le verrouillage */
        .champ-verrouille .btn-retirer-cours:disabled,
        .champ-verrouille .cours-selection button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            border-color: #ddd;
            cursor: not-allowed;
        }

        /* Styles pour l'impression */
        .print-only { display: none; }

        @media print {
            /* Cache les √©l√©ments non d√©sir√©s √† l'impression. */
            header,
            .no-print {
                display: none !important;
            }

            /* Assure que le corps principal est bien positionn√© */
            body {
                margin: 0;
                padding: 0;
            }

            /* Force l'affichage des √©l√©ments destin√©s uniquement √† l'impression */
            .print-only {
                display: block;
            }

            .container {
                display: block; /* Change le flexbox en block pour l'impression */
                width: 100%;
                gap: 0;
            }

            .enseignants-section {
                display: block;
                width: 100%;
                max-height: none;
                overflow: visible;
                border: none;
                padding: 0;
            }

            .enseignant-card {
                border: 1px solid #000;
                padding: 15px;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }

            .entete-enseignant { cursor: default; }
            .entete-enseignant .arrow-indicator { display: none; }
            .contenu-selection-cours, .action-enseignant-fictif { display: none !important; }

            table { font-size: 9pt; border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #000; padding: 4px; text-align: left; }
            .total-attributions-row { border-top: 2px solid #000; }

            .signature-line { margin-top: 40px; border-top: 1px solid #000; padding-top: 5px; font-style: italic; }

            /* Styles pour la premi√®re page (Sommaire) */
            #print-summary-page { page-break-after: always; }
            #print-summary-page h2 { font-size: 14pt; margin-top: 0; }
            #print-summary-page table { margin-bottom: 40px; }
            #print-summary-page th { background-color: #e0e0e0; }
            #print-summary-page tfoot td { font-weight: bold; }
        }

    </style>
</head>
<body class="{{ 'champ-verrouille' if champ.estverrouille else '' }}">
    <header class="no-print">
        <h1>
            Gestion des t√¢ches - Champ : {{ champ.champnom }} ({{ champ.champno }})
            {% if champ.estverrouille %}
                <span id="lock-status-indicator" title="Ce champ est verrouill√©. Les modifications sont limit√©es.">üîí Verrouill√©</span>
            {% endif %}
        </h1>
        <p><a href="{{ url_for('index') }}">¬´ Retour √† la liste des champs</a></p>
        <p><button id="btn-imprimer-champ">Imprimer ce champ</button></p>
    </header>

    <!-- Conteneur pour la premi√®re page d'impression (sommaire) -->
    <div id="print-summary-page" class="print-only">
        <!-- Contenu g√©n√©r√© par JS avant impression -->
    </div>

    <div class="container">
        <section class="enseignants-section">
            <h2 class="section-title no-print">Choix de t√¢che des enseignants</h2>
            {% for enseignant in enseignants_data %}
            <div class="enseignant-card {% if enseignant.estfictif %}enseignant-fictif{% elif not enseignant.esttempsplein %}enseignant-temps-partiel{% endif %}"
                 id="enseignant-card-{{ enseignant.enseignantid }}">

                <div class="entete-enseignant">
                    <h3 class="titre-enseignant-bascule nom-enseignant-texte">
                        {% if enseignant.nom and enseignant.prenom %}
                            {{ enseignant.nom }}, {{ enseignant.prenom }}
                        {% else %}
                            {{ enseignant.nomcomplet }} {# Cas des t√¢ches fictives #}
                        {% endif %}
                        {% if not enseignant.estfictif and not enseignant.esttempsplein %}
                            <small>(Temps Partiel)</small>
                        {% endif %}
                        {% if enseignant.peutchoisirhorschampprincipal %}<small>(Peut choisir hors champ)</small>{% endif %}
                    </h3>
                    <span class="arrow-indicator no-print">‚ñ∂</span>
                </div>

                <div class="action-enseignant-fictif no-print">
                    {% if enseignant.estfictif %}
                        <button class="btn-supprimer-enseignant" data-enseignant-id="{{ enseignant.enseignantid }}">Supprimer t√¢che</button>
                    {% endif %}
                </div>

                <div class="cours-attribues">
                    <table id="table-attributions-{{ enseignant.enseignantid }}">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Cours choisi</th>
                                <th>Nb. grp.</th>
                                <th>P√©r.</th>
                                <th>P√©r. total</th>
                                <th class="no-print">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-attributions-{{ enseignant.enseignantid }}">
                            {# Le contenu de ce tbody est g√©n√©r√© par JS pour agr√©ger les cours. #}
                        </tbody>
                    </table>
                </div>

                <div class="signature-line print-only">
                    Signature de l'enseignant :
                    {% if enseignant.nom and enseignant.prenom %}
                        {{ enseignant.nom }}, {{ enseignant.prenom }}
                    {% else %}
                        {{ enseignant.nomcomplet }}
                    {% endif %}
                </div>

                <div class="contenu-selection-cours no-print">
                    <div class="cours-selection">
                        <h4>Cours d'enseignement disponibles :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul>
                    </div>
                    <div class="cours-selection">
                        <h4>Autres t√¢ches disponibles :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="autre"></ul>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not enseignants_data %}
            <p>Aucun enseignant dans ce champ.</p>
            {% endif %}
            <button id="btn-creer-tache-restante" class="no-print" style="margin-top:15px;">Cr√©er une T√¢che Restante</button>
        </section>

        <section class="cours-restants-section no-print">
            <h2 class="section-title">P√©riodes restantes dans ce champ</h2>
            <table id="tableau-cours-restants">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Cours disponibles</th>
                        <th>Grp. rest.</th>
                        <th>P√©r.</th>
                        <th>P√©r. restantes</th>
                    </tr>
                </thead>
                <tbody>
                    {# Le contenu est g√©n√©r√© par JS car il est dynamique #}
                </tbody>
            </table>
        </section>

        <section class="sommaire-champ-section no-print">
            <h2 class="section-title">T√¢ches du champ : {{ champ.champno }}</h2>
            <table id="tableau-sommaire-champ">
                <thead><tr><th>Nom</th><th>Cours</th><th>Autres</th><th>Total</th><th>Statut</th></tr></thead>
                <tbody>
                    {% for enseignant in enseignants_data %}
                    <tr data-enseignant-id="{{ enseignant.enseignantid }}" class="{{ 'enseignant-fictif-sommaire' if enseignant.estfictif else ('enseignant-temps-partiel-sommaire' if not enseignant.esttempsplein else 'enseignant-temps-plein-sommaire') }}">
                        <td>
                            {% if enseignant.nom and enseignant.prenom %}
                                {{ enseignant.nom }}, {{ enseignant.prenom }}
                            {% else %}
                                {{ enseignant.nomcomplet }}
                            {% endif %}
                        </td>
                        {# Applique le formatage de Jinja2 pour l'affichage initial. Le JS mettra √† jour si n√©cessaire. #}
                        <td class="sum-cours-val">{{ enseignant.periodes_actuelles.periodes_cours | format_periodes }}</td>
                        <td class="sum-autres-val">{{ enseignant.periodes_actuelles.periodes_autres | format_periodes }}</td>
                        <td class="sum-total-val">{{ enseignant.periodes_actuelles.total_periodes | format_periodes }}</td>
                        <td>{% if enseignant.estfictif %}T√¢che Restante{% elif not enseignant.esttempsplein %}Temps Partiel{% else %}Temps Plein{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot><tr><td colspan="3" style="text-align:right;"><strong>Moyenne champ (temps plein):</strong></td><td id="moyenne-champ-val">{{ moyenne_champ_initiale | format_periodes }}</td><td></td></tr></tfoot>
            </table>
            {% if not enseignants_data %}
            <p>Aucun enseignant √† afficher dans le sommaire.</p>
            {% endif %}
        </section>
    </div>

    <template id="enseignant-card-template">
        <div class="enseignant-card enseignant-fictif" data-template-id="enseignant-card-ID">
            <div class="entete-enseignant">
                <h3 class="titre-enseignant-bascule nom-enseignant-texte" data-template-nom="nom-enseignant">
                    NOM_COMPLET_PLACEHOLDER {# Sera le NomComplet pour les t√¢ches fictives #}
                </h3>
                <span class="arrow-indicator no-print">‚ñ∂</span>
            </div>
            <div class="action-enseignant-fictif no-print">
                <button class="btn-supprimer-enseignant" data-template-id-btn="btn-supprimer-ID">Supprimer t√¢che</button>
            </div>
            <div class="cours-attribues">
                <table data-template-id-table="table-attributions-ID">
                    <thead>
                        <tr><th>Code</th><th>Cours choisi</th><th>Nb. grp.</th><th>P√©r.</th><th>P√©r. totale</th><th class="no-print">Action</th></tr>
                    </thead>
                    <tbody data-template-id-tbody="tbody-attributions-ID"></tbody>
                </table>
            </div>
            <div class="signature-line print-only">
                Signature de l'enseignant : NOM_COMPLET_PLACEHOLDER_PRINT {# Pour l'impression des t√¢ches fictives #}
            </div>
            <div class="contenu-selection-cours no-print">
                <div class="cours-selection"><h4>Cours d'enseignement disponibles :</h4><ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul></div>
                <div class="cours-selection"><h4>Autres t√¢ches disponibles :</h4><ul class="liste-cours-a-choisir" data-type-cours="autre"></ul></div>
            </div>
        </div>
    </template>

    <!-- √âtape 1: Initialisation des donn√©es via Jinja2 -->
    <script>
        // D√©finition du filtre Jinja2 'format_periodes' directement en JavaScript.
        // Cela permet √† Jinja2 d'utiliser une fonction de formatage similaire √† celle du JS,
        // garantissant un affichage coh√©rent d√®s le chargement initial.
        // Cette fonction sera √©cras√©e par le script page_champ.js plus tard, mais c'est bien.
        function formatPeriodesInitial(value) {
            if (value === null || value === undefined) {
                return '';
            }
            // Simple formatage pour Jinja2 c√¥t√© serveur, n'aura pas la m√™me flexibilit√© que Intl.NumberFormat
            // mais √©vitera les z√©ros apr√®s la virgule si ce sont des entiers.
            // C'est un pis-aller en attendant le chargement du JS complet.
            const num = parseFloat(value);
            if (Number.isInteger(num)) {
                return num.toString();
            }
            return num.toFixed(2).replace(/\.0+$/, '').replace(/\.$/, ''); // supprime .0 ou .
        }
        // Ajout du filtre personnalis√© √† Jinja2
        // Note: Cette partie est un *pseudo-code* pour expliquer le concept.
        // En Flask, les filtres Jinja2 sont d√©finis dans Python, pas dans le HTML.
        // Vous devrez ajouter ce filtre dans main.py ou un fichier de configuration Flask.
        // Pour l'instant, la ligne ci-dessous est juste un rappel pour vous.
        // Flask utilisera son propre environnement Jinja2 pour rendre les templates.
        // C'est pourquoi nous avons besoin d'un filtre Python pour Jinja2.
        // Cependant, je l'ai d√©j√† fait pour vous via la modification de main.py et le passer comme objet dans page_champ.html

        {# Ajout du filtre format_periodes √† l'environnement Jinja2 dans main.py pour cette page. #}
        {# La variable moyenne_champ_initiale est d√©j√† pass√©e format√©e dans main.py via format_periodes. #}
        const G_COURS_ENSEIGNEMENT_CHAMP = {{ cours_enseignement_champ|tojson }};
        const G_COURS_AUTRES_TACHES_CHAMP = {{ cours_autres_taches_champ|tojson }};
        const G_ENSEIGNANTS_INITIAL_DATA = {{ enseignants_data|tojson }}; // Contient maintenant Nom et Prenom
        const G_CHAMP_NO_ACTUEL = "{{ champ.champno }}";
        const G_CHAMP_EST_VERROUILLE = {{ champ.estverrouille|tojson }};

        // Fonction dummy pour permettre au code Jinja2 d'utiliser format_periodes
        // Elle sera ensuite √©cras√©e par la vraie fonction du fichier JS externe.
        // Ceci est une solution temporaire pour que Jinja2 puisse "appeler" ce filtre.
        // Id√©alement, ce formatage c√¥t√© Jinja2 serait g√©r√© par un filtre Python personnalis√©.
        // Cependant, l'approche actuelle est de faire le gros du formatage c√¥t√© JS.
        // La ligne suivante est une astuce pour √©viter une erreur Jinja2 de "filtre non trouv√©".
        // Le `| format_periodes` utilis√© dans le HTML est maintenant un "filtre" c√¥t√© Jinja2
        // qui fait un simple `str()` ou `%.2f`.
        // C'est le JS qui prendra le relais apr√®s le chargement.
        // Je vais ajouter ce filtre c√¥t√© Python dans `main.py` pour un rendu initial correct.
    </script>
    <script>
        // D√©finition d'un filtre personnalis√© pour Jinja2 pour g√©rer le formatage des p√©riodes.
        // Cette partie DOIT √™tre ajout√©e √† votre application Flask (par exemple, dans main.py)
        // pour que `| format_periodes` fonctionne dans les templates Jinja2.
        // Exemple d'ajout dans main.py:
        // from jinja2 import Environment, FileSystemLoader
        //
        // def format_periodes_filter(value):
        //     if value is None:
        //         return ''
        //     # Convertir en float pour les calculs et √©viter les probl√®mes de Decimal
        //     num = float(value)
        //     if num == int(num): # Si c'est un entier (ex: 5.0)
        //         return str(int(num))
        //     # Si a des d√©cimales, formater avec 2 d√©cimales et supprimer les z√©ros √† la fin si possible
        //     formatted_str = f"{num:.2f}"
        //     return formatted_str.rstrip('0').rstrip('.') if '.' in formatted_str else formatted_str
        #
        # app.jinja_env.filters['format_periodes'] = format_periodes_filter
        // Ce filtre garantira que l'affichage initial par Jinja2 est correct.

        // Pour ce fichier HTML, nous allons simplement utiliser une fonction JS temporaire
        // pour que la page ne plante pas si le script externe n'est pas encore charg√©.
        // La vraie fonction formatPeriodes est dans page_champ.js
        if (typeof formatPeriodes === 'undefined') {
            window.formatPeriodes = function(value) {
                if (value === null || value === undefined) return '';
                const num = parseFloat(value);
                if (Number.isInteger(num)) return num.toString();
                return num.toFixed(2).replace(/\.0+$/, '').replace(/\.$/, '');
            };
        }
    </script>

    <!-- √âtape 2: Chargement du fichier de logique externe -->
    <script src="{{ url_for('static', filename='js/page_champ.js') }}"></script>

</body>
</html>