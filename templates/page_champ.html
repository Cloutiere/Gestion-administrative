<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tâches - Champ {{ champ.champnom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles spécifiques pour la page de gestion d'un champ */
        .container { 
            display: flex; 
            gap: 20px; 
            flex-wrap: nowrap;
        }

        .enseignants-section { 
            flex: 2; 
            min-width: 400px; 
            max-height: calc(100vh - 200px); /* Hauteur maximale pour permettre le défilement interne */
            overflow-y: auto; /* Défilement vertical pour la section des enseignants si elle dépasse la hauteur max */
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
        }

        .cours-restants-section, .sommaire-champ-section { 
            flex: 1; 
            min-width: 300px; 
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
            max-height: calc(100vh - 200px); /* Hauteur maximale pour ces sections aussi */
            overflow-y: auto; /* Permettre le défilement si le contenu est trop grand */
        }

        .enseignant-card { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: #fff; 
            transition: background-color 0.3s ease;
        }

        .enseignant-fictif { background-color: #f0f8ff; border-left: 5px solid #cce5ff; } 

        .enseignant-card.detail-visible {
            background-color: #e7f3fe; 
            border-left: 5px solid #007bff; 
        }

        .entete-enseignant {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
        }
        .entete-enseignant:hover { background-color: #f0f0f0; }
        .entete-enseignant .arrow-indicator { margin-left: 10px; transition: transform 0.3s ease; }
        .enseignant-card.detail-visible .entete-enseignant .arrow-indicator { transform: rotate(90deg); }

        /* Réduction de la marge inférieure du h3 pour le rapprocher du tableau */
        .entete-enseignant h3.titre-enseignant-bascule {
            margin-bottom: 5px; /* Ajusté pour moins d'espace */
        }

        .nom-enseignant-texte {
            flex-grow: 1;
        }

        .action-enseignant-fictif {
            text-align: right; 
            margin-top: 0; /* Réduit pour coller */
            margin-bottom: 5px; /* Espace avant le tableau des attributions */
        }

        .contenu-selection-cours { 
            display: none; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px dashed #eee; 
        }
        .enseignant-card.detail-visible .contenu-selection-cours { display: block; }

        /* Style global pour les tables, sauf si surchargé */
        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        
        /* Surcharge pour les tables d'attribution pour réduire l'espace supérieur */
        div.cours-attribues > table {
            margin-top: 5px; /* Réduit pour coller au nom/bouton */
        }

        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background-color: #e9ecef; }
        
        .sous-titre-cours-restants td, .sous-titre-attributions td {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            border-top: 2px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        
        .total-attributions-row td {
            font-weight: bold;
            background-color: #e9ecef; 
            text-align: right; 
        }
        .total-attributions-row td:first-child {
             text-align: left; 
        }

        .cours-attribues {
            margin-top: 0px; /* Réduit pour coller aux éléments précédents */
        }

        .cours-selection button, .btn-retirer-cours, .btn-supprimer-enseignant {
            margin-left:5px; cursor:pointer; padding: 3px 8px; font-size: 0.85em;
        }
        .btn-retirer-cours, .btn-supprimer-enseignant { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .btn-retirer-cours:hover, .btn-supprimer-enseignant:hover { background-color: #f5c6cb;}
        .section-title { margin-top: 20px; margin-bottom:10px; font-size: 1.2em; color: #333; border-bottom: 1px solid #eee; padding-bottom:5px;}
        
        .cours-selection { margin-top: 15px; }
        .cours-selection ul { list-style-type: none; padding-left: 0; margin-top: 5px; margin-bottom: 5px; }
        .cours-selection li { 
            margin-bottom: 2px; 
            padding: 3px 5px; 
            border-bottom: 1px dashed #eee; 
        }
        .cours-selection li:last-child { border-bottom: none; }

    </style>
</head>
<body>
    <header>
        <h1>Gestion des Tâches - Champ : {{ champ.champnom }} ({{ champ.champno }})</h1>
        <p><a href="{{ url_for('index') }}">« Retour à la liste des champs</a></p>
    </header>

    <div class="container">
        <section class="enseignants-section">
            <h2 class="section-title">Attribution des Tâches aux Enseignants</h2>
            {% for enseignant in enseignants %}
            <div class="enseignant-card {% if not enseignant.esttempsplein %}enseignant-temps-partiel{% endif %} {% if enseignant.estfictif %}enseignant-fictif{% endif %}"
                 id="enseignant-card-{{ enseignant.enseignantid }}">

                <div class="entete-enseignant">
                    <h3 class="titre-enseignant-bascule nom-enseignant-texte">
                        {{ enseignant.nomcomplet }}
                        {% if not enseignant.esttempsplein %}<small>(Temps Partiel)</small>{% endif %}
                        {% if enseignant.estfictif %}<small>(Tâche Restante)</small>{% endif %}
                        {% if enseignant.peutchoisirhorschampprincipal %}<small>(Peut choisir hors champ)</small>{% endif %}
                    </h3>
                    <span class="arrow-indicator">▶</span>
                </div>

                {% if enseignant.estfictif %}
                <div class="action-enseignant-fictif">
                    <button class="btn-supprimer-enseignant" data-enseignant-id="{{ enseignant.enseignantid }}">Supprimer Tâche</button>
                </div>
                {% endif %}
                
                <div class="cours-attribues">
                    <table id="table-attributions-{{ enseignant.enseignantid }}">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Cours choisi</th>
                                <th>Pér.</th>
                                <th>Nb. grp.</th>
                                <th>Pér. totale</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-attributions-{{ enseignant.enseignantid }}">
                            {# Contenu généré par JavaScript #}
                        </tbody>
                    </table>
                </div>

                <div class="contenu-selection-cours">
                    <div class="cours-selection">
                        <h4>Cours d'enseignement disponibles à l'attribution :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul>
                    </div>
                    <div class="cours-selection">
                        <h4>Autres tâches disponibles à l'attribution :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="autre"></ul>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not enseignants %}
            <p>Aucun enseignant dans ce champ.</p>
            {% endif %}
            <button id="btn-creer-tache-restante" style="margin-top:15px;">Créer une Tâche Restante</button>
        </section>

        <section class="cours-restants-section">
            <h2 class="section-title">Périodes Restantes dans ce Champ</h2>
            <table id="tableau-cours-restants">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Cours disponibles</th>
                        <th>Pér.</th>
                        <th>Grp. rest.</th>
                        <th>Pér. restantes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center;">Chargement des données...</td></tr>
                </tbody>
            </table>
        </section>

        <section class="sommaire-champ-section">
            <h2 class="section-title">Tâches du champ : {{ champ.champno }}</h2>
            <table id="tableau-sommaire-champ">
                <thead><tr><th>Nom</th><th>Cours</th><th>Autres</th><th>Total</th><th>Statut</th></tr></thead>
                <tbody>
                    {% for tache in taches_sommaire_champ %}
                    <tr data-enseignant-id="{{ tache.enseignant_id }}">
                        <td>{{ tache.nom }}</td><td class="sum-cours-val">{{ tache.periodes_cours }}</td>
                        <td class="sum-autres-val">{{ tache.periodes_autres }}</td><td class="sum-total-val">{{ tache.total_periodes }}</td>
                        <td>{% if tache.est_fictif %}Fictif{% elif not tache.est_temps_plein %}Temps Partiel{% else %}Temps Plein{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot><tr><td colspan="3" style="text-align:right;"><strong>Moyenne champ (temps plein):</strong></td><td id="moyenne-champ-val">{{ "%.2f"|format(moyenne_champ_initiale) }}</td><td></td></tr></tfoot>
            </table>
            {% if not taches_sommaire_champ %}
            <p>Aucun enseignant à afficher dans le sommaire.</p>
            {% endif %}
        </section>
    </div>

    <script>
        let G_COURS_ENSEIGNEMENT_CHAMP = []; 
        let G_COURS_AUTRES_TACHES_CHAMP = []; 
        let G_ENSEIGNANTS_INITIAL_DATA = []; 
        const G_CHAMP_NO_ACTUEL = "{{ champ.champno }}"; 

        document.addEventListener('DOMContentLoaded', function () {
            try {
                G_COURS_ENSEIGNEMENT_CHAMP = JSON.parse('{{ cours_enseignement_champ|tojson|safe }}');
                G_COURS_AUTRES_TACHES_CHAMP = JSON.parse('{{ cours_autres_taches_champ|tojson|safe }}');
                G_ENSEIGNANTS_INITIAL_DATA = JSON.parse('{{ enseignants|tojson|safe }}');
            } catch (e) {
                console.error("Erreur parsing JSON initial:", e);
                alert("Erreur chargement données page. Fonctionnalités affectées.");
            }

            initialiserTableauSommaire(); 
            regenererTableauCoursRestants(); 
            
            G_ENSEIGNANTS_INITIAL_DATA.forEach(enseignant => {
                regenererTableauAttributionsEnseignant(enseignant.enseignantid, enseignant.attributions || []);
                const enseignantCard = document.getElementById(`enseignant-card-${enseignant.enseignantid}`);
                if (enseignantCard) {
                    const ulEnseignement = enseignantCard.querySelector('ul.liste-cours-a-choisir[data-type-cours="enseignement"]');
                    if (ulEnseignement) {
                        ulEnseignement.innerHTML = genererListeHTMLCoursDispo(G_COURS_ENSEIGNEMENT_CHAMP, enseignant.enseignantid, 'enseignement');
                    }
                    const ulAutres = enseignantCard.querySelector('ul.liste-cours-a-choisir[data-type-cours="autre"]');
                    if (ulAutres) {
                        ulAutres.innerHTML = genererListeHTMLCoursDispo(G_COURS_AUTRES_TACHES_CHAMP, enseignant.enseignantid, 'autre');
                    }
                }
            });

            const enseignantsSection = document.querySelector('.enseignants-section');
            if (enseignantsSection) {
                enseignantsSection.addEventListener('click', gestionnaireClicsEnseignantsSection);
            }

            document.getElementById('btn-creer-tache-restante')?.addEventListener('click', async function() {
                await creerTacheRestante(this);
            });

            document.querySelectorAll('.entete-enseignant').forEach(entete => {
                entete.addEventListener('click', function() {
                    const enseignantCard = this.closest('.enseignant-card');
                    if (enseignantCard) {
                        const etaitVisible = enseignantCard.classList.contains('detail-visible');
                        document.querySelectorAll('.enseignant-card.detail-visible').forEach(card => {
                            card.classList.remove('detail-visible');
                        });
                        if (!etaitVisible) {
                            enseignantCard.classList.add('detail-visible');
                        }
                    }
                });
            });
        });
        
        function regenererTableauAttributionsEnseignant(enseignantId, attributionsArray) {
            const tbody = document.getElementById(`tbody-attributions-${enseignantId}`);
            if (!tbody) return;
            tbody.innerHTML = ''; 

            const attributionsEnseignement = attributionsArray.filter(attr => !attr.estcoursautre)
                .sort((a,b) => a.coursdescriptif.localeCompare(b.coursdescriptif));
            const attributionsAutres = attributionsArray.filter(attr => attr.estcoursautre)
                .sort((a,b) => a.coursdescriptif.localeCompare(b.coursdescriptif));

            let totalPeriodesEnseignantCalcule = 0;
            let contenuAjoute = false; // Pour savoir si on a ajouté au moins une ligne de cours

            if (attributionsEnseignement.length > 0) {
                const titreEnsRow = tbody.insertRow();
                titreEnsRow.classList.add('sous-titre-attributions');
                const titreEnsCell = titreEnsRow.insertCell();
                titreEnsCell.colSpan = 6; 
                titreEnsCell.textContent = "Périodes d'enseignement attribuées";
                contenuAjoute = true;
                
                attributionsEnseignement.forEach(attr => {
                    const row = tbody.insertRow();
                    const totalPeriodesAttr = attr.nbperiodes * attr.nbgroupespris;
                    totalPeriodesEnseignantCalcule += totalPeriodesAttr;
                    row.innerHTML = `
                        <td>${attr.codecours}</td>
                        <td>${attr.coursdescriptif}</td>
                        <td>${attr.nbperiodes}</td>
                        <td>${attr.nbgroupespris}</td>
                        <td>${totalPeriodesAttr}</td>
                        <td><button class="btn-retirer-cours" data-attribution-id="${attr.attributionid}">Retirer</button></td>
                    `;
                });
            }

            if (attributionsAutres.length > 0) {
                const titreAutresRow = tbody.insertRow();
                titreAutresRow.classList.add('sous-titre-attributions');
                const titreAutresCell = titreAutresRow.insertCell();
                titreAutresCell.colSpan = 6;
                titreAutresCell.textContent = "Autres tâches attribuées";
                contenuAjoute = true;

                attributionsAutres.forEach(attr => {
                    const row = tbody.insertRow();
                    const totalPeriodesAttr = attr.nbperiodes * attr.nbgroupespris;
                    totalPeriodesEnseignantCalcule += totalPeriodesAttr;
                    row.innerHTML = `
                        <td>${attr.codecours}</td>
                        <td>${attr.coursdescriptif}</td>
                        <td>${attr.nbperiodes}</td>
                        <td>${attr.nbgroupespris}</td>
                        <td>${totalPeriodesAttr}</td>
                        <td><button class="btn-retirer-cours" data-attribution-id="${attr.attributionid}">Retirer</button></td>
                    `;
                });
            }
            
            if (!contenuAjoute) { // Si aucune attribution (ni enseignement, ni autre)
                 const row = tbody.insertRow();
                 row.innerHTML = `<td colspan="6" style="text-align:center; font-style:italic;">Aucune période attribuée pour le moment.</td>`;
            }
            
            const totalRow = tbody.insertRow();
            totalRow.classList.add('total-attributions-row');
            const totalLabelCell = totalRow.insertCell();
            totalLabelCell.colSpan = 4; 
            totalLabelCell.textContent = "Total Périodes Attribuées:";
            
            const totalValueCell = totalRow.insertCell();
            totalValueCell.textContent = totalPeriodesEnseignantCalcule;
            
            totalRow.insertCell(); // Cellule vide pour la colonne Action
        }

        function gestionnaireClicsEnseignantsSection(event) {
            const target = event.target; 
            if (target.matches('.contenu-selection-cours .cours-selection button[data-enseignant-id][data-cours-code]')) {
                attribuerCours(target.dataset.enseignantId, target.dataset.coursCode, target.dataset.nbPeriodes, target);
            } 
            else if (target.classList.contains('btn-retirer-cours')) {
                if (confirm('Êtes-vous sûr de vouloir retirer ce cours ?')) {
                    retirerCours(target.dataset.attributionId, target);
                }
            } 
            else if (target.classList.contains('btn-supprimer-enseignant')) {
                if (confirm('Êtes-vous sûr de vouloir supprimer cette tâche restante et tous ses cours attribués ?')) {
                    supprimerEnseignantFictif(target.dataset.enseignantId, target);
                }
            }
        }

        async function attribuerCours(enseignantId, codeCours, _nbPeriodesCours, boutonClique) {
            boutonClique.disabled = true; 
            boutonClique.textContent = '...'; 
            try {
                const response = await fetch('/api/attributions/ajouter', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enseignant_id: parseInt(enseignantId), code_cours: codeCours })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || "Erreur attribution cours.");
                }
                
                mettreAJourLigneSommaire(enseignantId, data.periodes_enseignant);
                recalculerEtAfficherMoyenneChamp();
                
                regenererTableauAttributionsEnseignant(enseignantId, data.attributions_enseignant || []);

                mettreAJourDonneesGlobalesCours(codeCours, data.groupes_restants_cours);
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisirGlobale();


            } catch (error) {
                console.error('Erreur attribuerCours:', error);
                alert(error.message);
            } finally {
                boutonClique.disabled = false; 
                boutonClique.textContent = 'Attribuer';
            }
        }

        async function retirerCours(attributionId, boutonClique) {
            boutonClique.disabled = true; 
            boutonClique.textContent = '...'; 
            try {
                const response = await fetch('/api/attributions/supprimer', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ attribution_id: parseInt(attributionId) })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erreur retrait cours.');
                }

                mettreAJourLigneSommaire(data.enseignant_id, data.periodes_enseignant);
                recalculerEtAfficherMoyenneChamp();

                regenererTableauAttributionsEnseignant(data.enseignant_id, data.attributions_enseignant || []);

                mettreAJourDonneesGlobalesCours(data.code_cours, data.groupes_restants_cours);
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisirGlobale();

            } catch (error) {
                console.error('Erreur retirerCours:', error);
                alert(error.message);
            } finally {
                 boutonClique.disabled = false; 
                 boutonClique.textContent = 'Retirer';
            }
        }

        async function creerTacheRestante(boutonClique) {
            boutonClique.disabled = true;
            boutonClique.textContent = 'Création...';
            try {
                const response = await fetch(`/api/champs/${G_CHAMP_NO_ACTUEL}/taches_restantes/creer`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                if (!response.ok || !data.success || !data.enseignant) {
                    throw new Error(data.message || 'Erreur création tâche restante.');
                }
                
                const nouvelEnseignant = data.enseignant;
                G_ENSEIGNANTS_INITIAL_DATA.push(nouvelEnseignant); 
                ajouterEnseignantDynamiquement(nouvelEnseignant); 
                
                // Initialiser le tableau des attributions pour le nouvel enseignant (il sera vide)
                regenererTableauAttributionsEnseignant(nouvelEnseignant.enseignantid, []);
                
                const periodesInitiales = data.periodes_actuelles || {periodes_cours:0, periodes_autres:0, total_periodes:0};
                ajouterAuTableauSommaire(nouvelEnseignant, periodesInitiales);
                recalculerEtAfficherMoyenneChamp(); 
            } catch (error) {
                console.error('Erreur creerTacheRestante:', error);
                alert(error.message);
            } finally {
                boutonClique.disabled = false;
                boutonClique.textContent = 'Créer une Tâche Restante';
            }
        }

        async function supprimerEnseignantFictif(enseignantId, boutonClique) {
            boutonClique.disabled = true;
            boutonClique.textContent = 'Suppression...';
            try {
                const response = await fetch(`/api/enseignants/${enseignantId}/supprimer`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erreur suppression tâche.');
                }

                document.getElementById(`enseignant-card-${enseignantId}`)?.remove();
                document.querySelector(`.sommaire-champ-section tbody tr[data-enseignant-id="${enseignantId}"]`)?.remove();

                G_ENSEIGNANTS_INITIAL_DATA = G_ENSEIGNANTS_INITIAL_DATA.filter(e => e.enseignantid !== parseInt(enseignantId));

                if (data.cours_liberes_details && data.cours_liberes_details.length > 0) {
                    data.cours_liberes_details.forEach(cours_maj => {
                        mettreAJourDonneesGlobalesCours(cours_maj.code_cours, cours_maj.nouveaux_groupes_restants);
                    });
                }
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisirGlobale();
                recalculerEtAfficherMoyenneChamp(); 

            } catch (error) {
                console.error('Erreur supprimerEnseignantFictif:', error);
                alert(error.message);
                if (boutonClique && document.body.contains(boutonClique)) {
                     boutonClique.disabled = false; 
                     boutonClique.textContent = 'Supprimer Tâche';
                }
            }
        }

        function mettreAJourDonneesGlobalesCours(codeCours, nouveauxGrpRestants) {
            const coursTrouveE = G_COURS_ENSEIGNEMENT_CHAMP.find(c => c.codecours === codeCours);
            if (coursTrouveE) coursTrouveE.grprestant = nouveauxGrpRestants;

            const coursTrouveA = G_COURS_AUTRES_TACHES_CHAMP.find(c => c.codecours === codeCours);
            if (coursTrouveA) coursTrouveA.grprestant = nouveauxGrpRestants;
        }

        function regenererTableauCoursRestants() {
            const tbody = document.querySelector('#tableau-cours-restants tbody');
            if (!tbody) return;
            tbody.innerHTML = ''; 

            let contenuGenere = false;

            const titreEnsRow = tbody.insertRow();
            titreEnsRow.classList.add('sous-titre-cours-restants');
            const titreEnsCell = titreEnsRow.insertCell();
            titreEnsCell.colSpan = 5; 
            titreEnsCell.textContent = "Périodes d'enseignement";
            
            if (G_COURS_ENSEIGNEMENT_CHAMP.length > 0) {
                G_COURS_ENSEIGNEMENT_CHAMP.forEach(cours => {
                    const row = tbody.insertRow();
                    const periodesRestantes = cours.nbperiodes * cours.grprestant;
                    row.innerHTML = `<td>${cours.codecours}</td>
                                     <td>${cours.coursdescriptif}</td>
                                     <td>${cours.nbperiodes}</td>
                                     <td id="grp-restant-${cours.codecours}">${cours.grprestant}</td>
                                     <td>${periodesRestantes}</td>`;
                    contenuGenere = true;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5" style="text-align:center; font-style:italic;">Aucun cours d'enseignement disponible.</td>`;
            }

            const titreAutresRow = tbody.insertRow();
            titreAutresRow.classList.add('sous-titre-cours-restants');
            const titreAutresCell = titreAutresRow.insertCell();
            titreAutresCell.colSpan = 5; 
            titreAutresCell.textContent = "Périodes Autres";
            
            if (G_COURS_AUTRES_TACHES_CHAMP.length > 0) {
                G_COURS_AUTRES_TACHES_CHAMP.forEach(cours => {
                    const row = tbody.insertRow();
                    const periodesRestantes = cours.nbperiodes * cours.grprestant;
                    row.innerHTML = `<td>${cours.codecours}</td>
                                     <td>${cours.coursdescriptif}</td>
                                     <td>${cours.nbperiodes}</td>
                                     <td id="grp-restant-${cours.codecours}">${cours.grprestant}</td>
                                     <td>${periodesRestantes}</td>`;
                    contenuGenere = true;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5" style="text-align:center; font-style:italic;">Aucune autre tâche disponible.</td>`;
            }

            if (!contenuGenere && G_COURS_ENSEIGNEMENT_CHAMP.length === 0 && G_COURS_AUTRES_TACHES_CHAMP.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Aucun cours disponible dans ce champ.</td></tr>';
            }
        }

        function regenererToutesLesListesDeCoursAChoisirGlobale() {
            document.querySelectorAll('.enseignant-card').forEach(card => {
                const enseignantId = card.id.split('-').pop(); 
                const enseignantCard = document.getElementById(`enseignant-card-${enseignantId}`);
                if (enseignantCard) {
                    const ulEnseignement = enseignantCard.querySelector('ul.liste-cours-a-choisir[data-type-cours="enseignement"]');
                    if (ulEnseignement) {
                        ulEnseignement.innerHTML = genererListeHTMLCoursDispo(G_COURS_ENSEIGNEMENT_CHAMP, enseignantId, 'enseignement');
                    }

                    const ulAutres = enseignantCard.querySelector('ul.liste-cours-a-choisir[data-type-cours="autre"]');
                    if (ulAutres) {
                        ulAutres.innerHTML = genererListeHTMLCoursDispo(G_COURS_AUTRES_TACHES_CHAMP, enseignantId, 'autre');
                    }
                }
            });
        }


        function genererListeHTMLCoursDispo(listeCoursGlobale, enseignantId, typeCours) {
            let html = '';
            const coursAffichables = listeCoursGlobale.filter(cours => cours.grprestant > 0);

            if (coursAffichables.length > 0) {
                coursAffichables.forEach(cours => {
                    html += `<li>
                                ${cours.codecours} - ${cours.coursdescriptif} (${cours.nbperiodes} pér. - ${cours.grprestant} grp. rest.)
                                <button data-enseignant-id="${enseignantId}" data-cours-code="${cours.codecours}" 
                                        data-type="${typeCours}" data-nb-periodes="${cours.nbperiodes}">
                                    Attribuer
                                </button>
                             </li>`;
                });
            } else {
                html = `<li>Aucun cours de ce type disponible pour le moment.</li>`;
            }
            return html;
        }

        function mettreAJourLigneSommaire(enseignantId, periodes) {
            const ligne = document.querySelector(`.sommaire-champ-section tbody tr[data-enseignant-id="${enseignantId}"]`);
            if (ligne) {
                ligne.querySelector('.sum-cours-val').textContent = periodes.periodes_cours;
                ligne.querySelector('.sum-autres-val').textContent = periodes.periodes_autres;
                ligne.querySelector('.sum-total-val').textContent = periodes.total_periodes;
            }
        }
        
        function ajouterEnseignantDynamiquement(enseignant) {
            const container = document.querySelector('.enseignants-section');
            const btnCreerTache = document.getElementById('btn-creer-tache-restante'); 

            const card = document.createElement('div');
            card.className = `enseignant-card ${!enseignant.esttempsplein ? 'enseignant-temps-partiel' : ''} ${enseignant.estfictif ? 'enseignant-fictif' : ''}`;
            card.id = `enseignant-card-${enseignant.enseignantid}`;

            card.innerHTML = `
                <div class="entete-enseignant">
                    <h3 class="titre-enseignant-bascule nom-enseignant-texte">
                        ${enseignant.nomcomplet}
                        ${!enseignant.esttempsplein ? '<small>(Temps Partiel)</small>' : ''}
                        ${enseignant.estfictif ? '<small>(Tâche Restante)</small>' : ''}
                        ${enseignant.peutchoisirhorschampprincipal ? '<small>(Peut choisir hors champ)</small>' : ''}
                    </h3>
                    <span class="arrow-indicator">▶</span>
                </div>
                ${enseignant.estfictif ? 
                    `<div class="action-enseignant-fictif">
                        <button class="btn-supprimer-enseignant" data-enseignant-id="${enseignant.enseignantid}">Supprimer Tâche</button>
                    </div>` : ''}
                <div class="cours-attribues">
                    <table id="table-attributions-${enseignant.enseignantid}">
                        <thead>
                            <tr><th>Code</th><th>Cours choisi</th><th>Pér.</th><th>Nb. grp.</th><th>Pér. totale</th><th>Action</th></tr>
                        </thead>
                        <tbody id="tbody-attributions-${enseignant.enseignantid}">
                            </tbody>
                    </table>
                </div>
                <div class="contenu-selection-cours">
                    <div class="cours-selection"><h4>Cours d'enseignement disponibles à l'attribution :</h4><ul class="liste-cours-a-choisir" data-type-cours="enseignement">${genererListeHTMLCoursDispo(G_COURS_ENSEIGNEMENT_CHAMP, enseignant.enseignantid, 'enseignement')}</ul></div>
                    <div class="cours-selection"><h4>Autres tâches disponibles à l'attribution :</h4><ul class="liste-cours-a-choisir" data-type-cours="autre">${genererListeHTMLCoursDispo(G_COURS_AUTRES_TACHES_CHAMP, enseignant.enseignantid, 'autre')}</ul></div>
                </div>
            `;

            if (btnCreerTache) {
                container.insertBefore(card, btnCreerTache);
            } else {
                container.appendChild(card);
            }
            
            // Initialiser le tableau des attributions pour la nouvelle carte
            regenererTableauAttributionsEnseignant(enseignant.enseignantid, []);

            card.querySelector('.entete-enseignant')?.addEventListener('click', function() {
                const currentCard = this.closest('.enseignant-card');
                if (currentCard) {
                    const etaitVisible = currentCard.classList.contains('detail-visible');
                    document.querySelectorAll('.enseignant-card.detail-visible').forEach(openCard => {
                        openCard.classList.remove('detail-visible');
                    });
                    if (!etaitVisible) {
                        currentCard.classList.add('detail-visible');
                    }
                }
            });
        }

        function ajouterAuTableauSommaire(enseignant, periodes) {
            const tbody = document.querySelector('#tableau-sommaire-champ tbody');
            if (!tbody) return; 

            const row = tbody.insertRow();
            row.dataset.enseignantId = enseignant.enseignantid; 

            if (enseignant.estfictif) {
                row.classList.add('enseignant-fictif-sommaire');
            } else if (!enseignant.esttempsplein) {
                row.classList.add('enseignant-temps-partiel-sommaire');
            } else {
                row.classList.add('enseignant-temps-plein-sommaire'); 
            }

            row.innerHTML = `
                <td>${enseignant.nomcomplet}</td>
                <td class="sum-cours-val">${periodes.periodes_cours}</td>
                <td class="sum-autres-val">${periodes.periodes_autres}</td>
                <td class="sum-total-val">${periodes.total_periodes}</td>
                <td>${enseignant.estfictif ? 'Fictif' : (!enseignant.esttempsplein ? 'Temps Partiel' : 'Temps Plein')}</td>`;
        }

        function recalculerEtAfficherMoyenneChamp() {
            let totalPeriodes = 0;
            let countTempsPleinNonFictif = 0;

            document.querySelectorAll('#tableau-sommaire-champ tbody tr').forEach(row => {
                const estFictif = row.classList.contains('enseignant-fictif-sommaire');
                const estTempsPartiel = row.classList.contains('enseignant-temps-partiel-sommaire');
                if (!estFictif && !estTempsPartiel) { 
                    const totalCell = row.querySelector('.sum-total-val');
                    if (totalCell) {
                        totalPeriodes += parseInt(totalCell.textContent) || 0;
                    }
                    countTempsPleinNonFictif++;
                }
            });

            const moyenne = countTempsPleinNonFictif > 0 ? (totalPeriodes / countTempsPleinNonFictif) : 0;
            document.getElementById('moyenne-champ-val').textContent = moyenne.toFixed(2);
        }

        function initialiserTableauSommaire() {
            const lignesSommaire = document.querySelectorAll('#tableau-sommaire-champ tbody tr');
            const enseignantsData = G_ENSEIGNANTS_INITIAL_DATA; 

            lignesSommaire.forEach(row => {
                const enseignantIdAttendu = row.dataset.enseignantId; 
                let enseignantAssocie;

                if (enseignantIdAttendu) {
                     enseignantAssocie = enseignantsData.find(ens => String(ens.enseignantid) === enseignantIdAttendu);
                } else { 
                    const nomEnseignantSommaire = row.cells[0].textContent.trim();
                    enseignantAssocie = enseignantsData.find(ens => ens.nomcomplet === nomEnseignantSommaire);
                    if (enseignantAssocie) row.dataset.enseignantId = enseignantAssocie.enseignantid;
                }

                if (enseignantAssocie) {
                    row.classList.remove('enseignant-fictif-sommaire', 'enseignant-temps-partiel-sommaire', 'enseignant-temps-plein-sommaire');
                    if (enseignantAssocie.estfictif) {
                        row.classList.add('enseignant-fictif-sommaire');
                    } else if (!enseignantAssocie.esttempsplein) {
                        row.classList.add('enseignant-temps-partiel-sommaire');
                    } else { 
                        row.classList.add('enseignant-temps-plein-sommaire');
                    }
                } else {
                    console.warn(`Aucun enseignant correspondant trouvé dans G_ENSEIGNANTS_INITIAL_DATA pour la ligne de sommaire (ID attendu: ${enseignantIdAttendu}, Nom: ${row.cells[0].textContent.trim()})`);
                }
            });
            recalculerEtAfficherMoyenneChamp();
        }
    </script>
</body>
</html>