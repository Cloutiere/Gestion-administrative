<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tâches - Champ {{ champ.champnom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Styles spécifiques pour la page de gestion d'un champ */
        .container { 
            display: flex; 
            gap: 20px; 
            flex-wrap: nowrap;
        }

        .enseignants-section { 
            flex: 2; 
            min-width: 400px; 
            max-height: calc(100vh - 200px); /* Hauteur maximale pour permettre le défilement interne */
            overflow-y: auto; /* Défilement vertical pour la section des enseignants si elle dépasse la hauteur max */
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
        }

        .cours-restants-section, .sommaire-champ-section { 
            flex: 1; 
            min-width: 300px; 
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
            max-height: calc(100vh - 200px); /* Hauteur maximale pour ces sections aussi */
            overflow-y: auto; /* Permettre le défilement si le contenu est trop grand */
        }
        
        #lock-status-indicator {
            font-size: 0.8em;
            color: #dc3545;
            margin-left: 10px;
        }

        .enseignant-card { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: #fff; 
            transition: background-color 0.3s ease;
        }

        .enseignant-fictif { background-color: #f0f8ff; border-left: 5px solid #cce5ff; } 

        .enseignant-card.detail-visible {
            background-color: #e7f3fe; 
            border-left: 5px solid #007bff; 
        }

        .entete-enseignant {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
        }
        .entete-enseignant:hover { background-color: #f0f0f0; }
        .entete-enseignant .arrow-indicator { margin-left: 10px; transition: transform 0.3s ease; }
        .enseignant-card.detail-visible .entete-enseignant .arrow-indicator { transform: rotate(90deg); }

        .entete-enseignant h3.titre-enseignant-bascule { margin-bottom: 5px; }
        .nom-enseignant-texte { flex-grow: 1; }
        .action-enseignant-fictif { text-align: right; margin-top: 0; margin-bottom: 5px; }

        .contenu-selection-cours { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .enseignant-card.detail-visible .contenu-selection-cours { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        div.cours-attribues > table { margin-top: 5px; }

        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background-color: #e9ecef; }
        
        .sous-titre-cours-restants td, .sous-titre-attributions td {
            background-color: #f0f0f0; font-weight: bold; text-align: center;
            border-top: 2px solid #ccc; border-bottom: 1px solid #ccc;
        }
        
        .total-attributions-row td { font-weight: bold; background-color: #e9ecef; text-align: right; }
        .total-attributions-row td:first-child { text-align: left; }

        .cours-attribues { margin-top: 0px; }

        .cours-selection button, .btn-retirer-cours, .btn-supprimer-enseignant {
            margin-left:5px; cursor:pointer; padding: 3px 8px; font-size: 0.85em;
        }
        .btn-retirer-cours, .btn-supprimer-enseignant { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .btn-retirer-cours:hover, .btn-supprimer-enseignant:hover { background-color: #f5c6cb;}
        .section-title { margin-top: 20px; margin-bottom:10px; font-size: 1.2em; color: #333; border-bottom: 1px solid #eee; padding-bottom:5px;}
        
        .cours-selection { margin-top: 15px; }
        .cours-selection ul { list-style-type: none; padding-left: 0; margin-top: 5px; margin-bottom: 5px; }
        .cours-selection li { margin-bottom: 2px; padding: 3px 5px; border-bottom: 1px dashed #eee; }
        .cours-selection li:last-child { border-bottom: none; }
        
        /* Styles pour le verrouillage */
        .champ-verrouille .btn-retirer-cours:disabled,
        .champ-verrouille .cours-selection button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            border-color: #ddd;
            cursor: not-allowed;
        }

        /* Styles pour l'impression */
        .print-only { display: none; }
        .no-print { display: block; } /* ou flex, etc. selon l'élément en mode normal */

        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                width: 98%; 
                margin: 0 auto;
            }
            
            /* Cache les éléments non désirés à l'impression. */
            header, 
            .container > section:not(.enseignants-section), 
            #btn-creer-tache-restante, 
            .no-print,
            button.no-print,
            span.no-print
             { display: none !important; }
            
            .container { display: block; }
            .enseignants-section { display: block; width: 100%; max-height: none; overflow: visible; border: none; }
            
            .enseignant-card { border: 1px solid #000; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
            .entete-enseignant { cursor: default; }
            .entete-enseignant .arrow-indicator { display: none; }
            .contenu-selection-cours { display: none !important; } /* Caché car c'est pour l'interaction UI */
            .action-enseignant-fictif { display: none; } /* Caché car c'est pour l'interaction UI */
            
            table { font-size: 9pt; border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #000; padding: 4px; text-align: left; }
            .total-attributions-row { border-top: 2px solid #000; }

            /* Masque complètement la dernière colonne (Action) à l'impression. */
            th:last-child,
            td:last-child {
                display: none !important;
            }
            
            .print-only { display: block; }
            
            .signature-line {
                margin-top: 40px;
                border-top: 1px solid #000;
                padding-top: 5px;
                font-style: italic;
            }
            #print-report-cours-restants { margin-top: 30px; page-break-before: always; }
            #print-report-cours-restants h2 { font-size: 14pt; }
        }

    </style>
</head>
<body class="{{ 'champ-verrouille' if champ.estverrouille else '' }}">
    <header class="no-print">
        <h1>
            Gestion des Tâches - Champ : {{ champ.champnom }} ({{ champ.champno }})
            {% if champ.estverrouille %}
                <span id="lock-status-indicator" title="Ce champ est verrouillé. Les modifications sont limitées."> Verrouillé</span>
            {% endif %}
        </h1>
        <p><a href="{{ url_for('index') }}">« Retour à la liste des champs</a></p>
        <p><button id="btn-imprimer-champ">Imprimer ce champ</button></p>
    </header>

    <div class="container print-area">
        <section class="enseignants-section">
            <h2 class="section-title no-print">Attribution des Tâches aux Enseignants</h2>
            {% for enseignant in enseignants_data %}
            <div class="enseignant-card {% if not enseignant.esttempsplein %}enseignant-temps-partiel{% endif %} {% if enseignant.estfictif %}enseignant-fictif{% endif %}"
                 id="enseignant-card-{{ enseignant.enseignantid }}">

                <div class="entete-enseignant">
                    <h3 class="titre-enseignant-bascule nom-enseignant-texte">
                        {{ enseignant.nomcomplet }}
                        {% if not enseignant.esttempsplein %}<small>(Temps Partiel)</small>{% endif %}
                        {% if enseignant.estfictif %}<small>(Tâche Restante)</small>{% endif %}
                        {% if enseignant.peutchoisirhorschampprincipal %}<small>(Peut choisir hors champ)</small>{% endif %}
                    </h3>
                    <span class="arrow-indicator no-print">▶</span>
                </div>

                <div class="action-enseignant-fictif no-print">
                    {% if enseignant.estfictif %}
                        <button class="btn-supprimer-enseignant" data-enseignant-id="{{ enseignant.enseignantid }}">Supprimer Tâche</button>
                    {% endif %}
                </div>
                
                <div class="cours-attribues">
                    <table id="table-attributions-{{ enseignant.enseignantid }}">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Cours choisi</th>
                                <th>Nb. grp.</th>
                                <th>Pér.</th>
                                <th>Pér. totale</th>
                                <th class="no-print">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-attributions-{{ enseignant.enseignantid }}">
                            {# Le contenu de ce tbody est maintenant généré par une fonction JS pour les mises à jour. #}
                        </tbody>
                    </table>
                </div>

                <div class="signature-line print-only">
                    Signature de l'enseignant :
                </div>

                <div class="contenu-selection-cours no-print">
                    <div class="cours-selection">
                        <h4>Cours d'enseignement disponibles à l'attribution :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul>
                    </div>
                    <div class="cours-selection">
                        <h4>Autres tâches disponibles à l'attribution :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="autre"></ul>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not enseignants_data %}
            <p>Aucun enseignant dans ce champ.</p>
            {% endif %}
            <button id="btn-creer-tache-restante" class="no-print" style="margin-top:15px;">Créer une Tâche Restante</button>
        </section>

        <section class="cours-restants-section no-print">
            <h2 class="section-title">Périodes Restantes dans ce Champ</h2>
            <table id="tableau-cours-restants">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Cours disponibles</th>
                        <th>Pér.</th>
                        <th>Grp. rest.</th>
                        <th>Pér. restantes</th>
                    </tr>
                </thead>
                <tbody>
                    {# Le contenu est généré par JS car il est dynamique #}
                </tbody>
            </table>
        </section>

        <section class="sommaire-champ-section no-print">
            <h2 class="section-title">Tâches du champ : {{ champ.champno }}</h2>
            <table id="tableau-sommaire-champ">
                <thead><tr><th>Nom</th><th>Cours</th><th>Autres</th><th>Total</th><th>Statut</th></tr></thead>
                <tbody>
                    {% for enseignant in enseignants_data %}
                    <tr data-enseignant-id="{{ enseignant.enseignantid }}" class="{{ 'enseignant-fictif-sommaire' if enseignant.estfictif else ('enseignant-temps-partiel-sommaire' if not enseignant.esttempsplein else 'enseignant-temps-plein-sommaire') }}">
                        <td>{{ enseignant.nomcomplet }}</td>
                        <td class="sum-cours-val">{{ enseignant.periodes_actuelles.periodes_cours }}</td>
                        <td class="sum-autres-val">{{ enseignant.periodes_actuelles.periodes_autres }}</td>
                        <td class="sum-total-val">{{ enseignant.periodes_actuelles.total_periodes }}</td>
                        <td>{% if enseignant.estfictif %}Fictif{% elif not enseignant.esttempsplein %}Temps Partiel{% else %}Temps Plein{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot><tr><td colspan="3" style="text-align:right;"><strong>Moyenne champ (temps plein):</strong></td><td id="moyenne-champ-val">{{ "%.2f"|format(moyenne_champ_initiale) }}</td><td></td></tr></tfoot>
            </table>
            {% if not enseignants_data %}
            <p>Aucun enseignant à afficher dans le sommaire.</p>
            {% endif %}
        </section>
    </div>
    
    <div id="print-report-cours-restants" class="print-only">
        <!-- Contenu généré par JS avant impression -->
    </div>

    <template id="enseignant-card-template">
        <div class="enseignant-card enseignant-fictif" id="enseignant-card-{{ENSEIGNANT_ID}}">
            <div class="entete-enseignant">
                <h3 class="titre-enseignant-bascule nom-enseignant-texte">
                    {{NOM_COMPLET}} <small>(Tâche Restante)</small>
                </h3>
                <span class="arrow-indicator no-print">▶</span>
            </div>
            <div class="action-enseignant-fictif no-print">
                <button class="btn-supprimer-enseignant" data-enseignant-id="{{ENSEIGNANT_ID}}">Supprimer Tâche</button>
            </div>
            <div class="cours-attribues">
                <table id="table-attributions-{{ENSEIGNANT_ID}}">
                    <thead>
                        <tr><th>Code</th><th>Cours choisi</th><th>Nb. grp.</th><th>Pér.</th><th>Pér. totale</th><th class="no-print">Action</th></tr>
                    </thead>
                    <tbody id="tbody-attributions-{{ENSEIGNANT_ID}}"></tbody>
                </table>
            </div>
            <div class="signature-line print-only">Signature de l'enseignant :</div>
            <div class="contenu-selection-cours no-print">
                <div class="cours-selection"><h4>Cours d'enseignement disponibles à l'attribution :</h4><ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul></div>
                <div class="cours-selection"><h4>Autres tâches disponibles à l'attribution :</h4><ul class="liste-cours-a-choisir" data-type-cours="autre"></ul></div>
            </div>
        </div>
    </template>

    <!-- Étape 1: Initialisation des données via Jinja2 -->
    <script>
        const G_COURS_ENSEIGNEMENT_CHAMP = {{ cours_enseignement_champ|tojson }};
        const G_COURS_AUTRES_TACHES_CHAMP = {{ cours_autres_taches_champ|tojson }};
        const G_ENSEIGNANTS_INITIAL_DATA = {{ enseignants_data|tojson }};
        const G_CHAMP_NO_ACTUEL = "{{ champ.champno }}"; 
        const G_CHAMP_EST_VERROUILLE = {{ champ.estverrouille|tojson }};
    </script>
    
    <!-- Étape 2: Chargement du fichier de logique externe -->
    <script src="{{ url_for('static', filename='js/page_champ.js') }}"></script>

</body>
</html>