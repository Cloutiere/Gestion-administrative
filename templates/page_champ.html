<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tâches - Champ {{ champ.champnom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles spécifiques pour la page de gestion d'un champ */
        .container { 
            display: flex; 
            gap: 20px; 
            flex-wrap: nowrap;
        }

        .enseignants-section { 
            flex: 2; 
            min-width: 400px; 
            max-height: calc(100vh - 200px); /* Ajustez cette valeur ! */
            overflow-y: auto; 
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
        }

        .cours-restants-section, .sommaire-champ-section { 
            flex: 1; 
            min-width: 300px; 
            padding:10px; 
            border: 1px solid #ccc; 
            border-radius:5px; 
            background-color: #f9f9f9;
        }

        .enseignant-card { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: #fff; 
            transition: background-color 0.3s ease; /* Pour une transition douce du surlignage */
        }

        /* Supprimer le style spécifique pour temps partiel qui ajoutait un fond rose */
        /* .enseignant-temps-partiel { background-color: #fff0f0; border-left: 5px solid #ffcccc; } */
        .enseignant-temps-partiel .titre-enseignant-bascule small:first-of-type { 
            /* Optionnel: garder une indication visuelle pour temps partiel dans le titre si désiré, sans fond */
            /* color: #b94a48; */ /* Exemple de couleur pour le texte "Temps Partiel" */
        }


        .enseignant-fictif { background-color: #f0f8ff; border-left: 5px solid #cce5ff; } 

        /* Nouveau style pour surligner la carte active (détail visible) */
        .enseignant-card.detail-visible {
            background-color: #e7f3fe; /* Bleu clair pour le surlignage, similaire à .highlight-moyenne */
            border-left: 5px solid #007bff; /* Bordure plus prononcée pour l'actif */
        }

        .titre-enseignant-bascule { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .titre-enseignant-bascule:hover { background-color: #f0f0f0; }
        .titre-enseignant-bascule .arrow-indicator { margin-left: 10px; transition: transform 0.3s ease; }
        .enseignant-card.detail-visible .titre-enseignant-bascule .arrow-indicator { transform: rotate(90deg); }

        .vue-detaillee-contenu { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .enseignant-card.detail-visible .vue-detaillee-contenu { display: block; }

        .resume-cours-attribues-list { list-style-type: none; padding-left: 0; margin-top: 5px; font-size: 0.9em; }
        .resume-cours-attribues-list li { padding: 2px 0; }

        table { width: 100%; border-collapse: collapse; margin-top:10px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background-color: #e9ecef; }
        .cours-selection button, .btn-retirer-cours, .btn-supprimer-enseignant {
            margin-left:5px; cursor:pointer; padding: 3px 8px; font-size: 0.85em;
        }
        .btn-retirer-cours, .btn-supprimer-enseignant { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .btn-retirer-cours:hover, .btn-supprimer-enseignant:hover { background-color: #f5c6cb;}
        .section-title { margin-top: 20px; margin-bottom:10px; font-size: 1.2em; color: #333; border-bottom: 1px solid #eee; padding-bottom:5px;}
        .cours-attribues ul, .cours-selection ul { list-style-type: none; padding-left: 0; }
        .cours-attribues li, .cours-selection li { margin-bottom: 5px; padding: 5px; border-bottom: 1px dashed #eee; }
        .cours-attribues li:last-child, .cours-selection li:last-child { border-bottom: none; }
        .liste-cours-a-choisir li[data-complet="true"] { opacity:0.5; text-decoration:line-through; }
        .liste-cours-a-choisir li[data-complet="true"] button { display:none; }
    </style>
</head>
<body>
    <header>
        <h1>Gestion des Tâches - Champ : {{ champ.champnom }} ({{ champ.champno }})</h1>
        <p><a href="{{ url_for('index') }}">« Retour à la liste des champs</a></p>
    </header>

    <div class="container">
        <!-- La classe 'enseignant-temps-partiel' est toujours ajoutée par Jinja, mais son style de fond a été retiré/commenté -->
        <section class="enseignants-section">
            <h2 class="section-title">Attribution des Tâches aux Enseignants</h2>
            {% for enseignant in enseignants %}
            <div class="enseignant-card {% if not enseignant.esttempsplein %}enseignant-temps-partiel{% endif %} {% if enseignant.estfictif %}enseignant-fictif{% endif %}"
                 id="enseignant-card-{{ enseignant.enseignantid }}">

                <div class="vue-condensee">
                    <h3 class="titre-enseignant-bascule">
                        <span>
                            {{ enseignant.nomcomplet }}
                            {% if not enseignant.esttempsplein %}<small>(Temps Partiel)</small>{% endif %}
                            {% if enseignant.estfictif %}<small>(Tâche Restante)</small>{% endif %}
                            {% if enseignant.peutchoisirhorschampprincipal %}<small>(Peut choisir hors champ)</small>{% endif %}
                        </span>
                        <span class="arrow-indicator">▶</span>
                    </h3>
                    <div class="resume-cours-attribues">
                        <ul class="resume-cours-attribues-list" id="resume-attributions-list-{{ enseignant.enseignantid }}">
                            {# Généré par JavaScript #}
                        </ul>
                    </div>
                    <p><strong>Total Périodes:</strong> <span id="total-gen-condense-{{ enseignant.enseignantid }}">{{ enseignant.periodes_actuelles.total_periodes }}</span></p>
                </div>

                <div class="vue-detaillee-contenu">
                    {% if enseignant.estfictif %}
                        <button class="btn-supprimer-enseignant" data-enseignant-id="{{ enseignant.enseignantid }}" style="float:right; margin-bottom:5px;">Supprimer Tâche</button>
                    {% endif %}
                    <div class="cours-attribues">
                        <h4>Cours Actuellement Attribués (Détail) :</h4>
                        <ul id="attributions-list-{{ enseignant.enseignantid }}">
                            {% for attribution in enseignant.attributions %}
                            <li data-attribution-id="{{ attribution.attributionid }}" data-codecours="{{ attribution.codecours }}" data-nbperiodes="{{ attribution.nbperiodes }}">
                                {{ attribution.coursdescriptif }} ({{ attribution.nbperiodes }} pér. x {{ attribution.nbgroupespris }} grp)
                                <button class="btn-retirer-cours" data-attribution-id="{{ attribution.attributionid }}">Retirer</button>
                            </li>
                            {% else %}
                            <li class="no-attributions">Aucun cours attribué pour le moment.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="cours-selection">
                        <h4>Cours d'enseignement disponibles :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="enseignement"></ul>
                    </div>
                    <div class="cours-selection">
                        <h4>Autres tâches disponibles (coordination, soutien) :</h4>
                        <ul class="liste-cours-a-choisir" data-type-cours="autre"></ul>
                    </div>
                    <p><strong>Total Périodes Enseignement:</strong> <span id="total-ens-{{ enseignant.enseignantid }}">{{ enseignant.periodes_actuelles.periodes_cours }}</span></p>
                    <p><strong>Total Périodes Autres:</strong> <span id="total-autre-{{ enseignant.enseignantid }}">{{ enseignant.periodes_actuelles.periodes_autres }}</span></p>
                    <p><strong>Total Général (Détail):</strong> <span id="total-gen-detail-{{ enseignant.enseignantid }}">{{ enseignant.periodes_actuelles.total_periodes }}</span></p>
                </div>
            </div>
            {% endfor %}
            {% if not enseignants %}
            <p>Aucun enseignant dans ce champ.</p>
            {% endif %}
            <button id="btn-creer-tache-restante" style="margin-top:15px;">Créer une Tâche Restante</button>
        </section>

        <!-- Sections latérales (inchangées) -->
        <section class="cours-restants-section">
            <h2 class="section-title">Périodes Restantes dans ce Champ</h2>
            <table id="tableau-cours-restants">
                <thead><tr><th>Code</th><th>Cours disponibles</th><th>Pér.</th><th>Grp. rest.</th></tr></thead>
                <tbody>
                    {% for cours in cours_disponibles_pour_tableau_restant %}
                    <tr>
                        <td>{{ cours.codecours }}</td><td>{{ cours.coursdescriptif }}</td>
                        <td>{{ cours.nbperiodes }}</td><td id="grp-restant-{{ cours.codecours }}">{{ cours.grprestant }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4">Aucun cours disponible ou tous les groupes sont attribués.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="sommaire-champ-section">
            <h2 class="section-title">Tâches du champ : {{ champ.champno }}</h2>
            <table id="tableau-sommaire-champ">
                <thead><tr><th>Nom</th><th>Cours</th><th>Autres</th><th>Total</th><th>Statut</th></tr></thead>
                <tbody>
                    {% for tache in taches_sommaire_champ %}
                    <tr data-enseignant-id="{{ tache.enseignant_id }}"> <!-- Assurez-vous que tache.enseignant_id est bien passé par main.py -->
                        <td>{{ tache.nom }}</td><td class="sum-cours-val">{{ tache.periodes_cours }}</td>
                        <td class="sum-autres-val">{{ tache.periodes_autres }}</td><td class="sum-total-val">{{ tache.total_periodes }}</td>
                        <td>{% if tache.est_fictif %}Fictif{% elif not tache.est_temps_plein %}Temps Partiel{% else %}Temps Plein{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot><tr><td colspan="3" style="text-align:right;"><strong>Moyenne champ (temps plein):</strong></td><td id="moyenne-champ-val">{{ "%.2f"|format(moyenne_champ_initiale) }}</td><td></td></tr></tfoot>
            </table>
            {% if not taches_sommaire_champ %}
            <p>Aucun enseignant à afficher dans le sommaire.</p>
            {% endif %}
        </section>
    </div>

    <script>
        // Variables globales (inchangées)
        let G_COURS_ENSEIGNEMENT_CHAMP = []; 
        let G_COURS_AUTRES_TACHES_CHAMP = []; 
        let G_ENSEIGNANTS_INITIAL_DATA = []; 
        const G_CHAMP_NO_ACTUEL = "{{ champ.champno }}"; 

        document.addEventListener('DOMContentLoaded', function () {
            // Parsing JSON (inchangé)
            try {
                G_COURS_ENSEIGNEMENT_CHAMP = JSON.parse('{{ cours_enseignement_champ|tojson|safe }}');
                G_COURS_AUTRES_TACHES_CHAMP = JSON.parse('{{ cours_autres_taches_champ|tojson|safe }}');
                G_ENSEIGNANTS_INITIAL_DATA = JSON.parse('{{ enseignants|tojson|safe }}');
            } catch (e) {
                console.error("Erreur parsing JSON initial:", e);
                alert("Erreur chargement données page. Fonctionnalités affectées.");
            }

            // Initialisations (inchangées)
            initialiserTableauSommaire(); 
            regenererToutesLesListesDeCoursAChoisir(); 
            initialiserToutesLesListesCondensees();

            // Gestionnaire de clics section enseignants (inchangé)
            const enseignantsSection = document.querySelector('.enseignants-section');
            if (enseignantsSection) {
                enseignantsSection.addEventListener('click', gestionnaireClicsEnseignantsSection);
            }

            // Gestionnaire création tâche restante (inchangé)
            document.getElementById('btn-creer-tache-restante')?.addEventListener('click', async function() {
                await creerTacheRestante(this);
            });

            // Gestionnaire pour basculer la vue détaillée des enseignants (inchangé)
            // La logique CSS s'occupe du surlignage via la classe '.detail-visible'
            document.querySelectorAll('.titre-enseignant-bascule').forEach(titre => {
                titre.addEventListener('click', function() {
                    const enseignantCard = this.closest('.enseignant-card');
                    if (enseignantCard) {
                        // Si on clique sur une carte déjà ouverte, on la ferme
                        if (enseignantCard.classList.contains('detail-visible')) {
                            enseignantCard.classList.remove('detail-visible');
                        } else {
                            // Sinon, on ferme toutes les autres et on ouvre celle-ci
                            document.querySelectorAll('.enseignant-card.detail-visible').forEach(card => {
                                card.classList.remove('detail-visible');
                            });
                            enseignantCard.classList.add('detail-visible');
                        }
                    }
                });
            });
        });

        // --- Toutes les fonctions JavaScript suivantes restent INCHANGÉES par rapport à la version précédente ---
        // initialiserToutesLesListesCondensees, regenererListeCondenseeAttributions, 
        // gestionnaireClicsEnseignantsSection, attribuerCours, retirerCours,
        // creerTacheRestante, supprimerEnseignantFictif, mettreAJourDonneesGlobalesCours,
        // regenererTableauCoursRestants, regenererToutesLesListesDeCoursAChoisir,
        // genererListeHTMLCoursDispo, mettreAJourTotauxPeriodesEnseignant,
        // mettreAJourLigneSommaire, ajouterCoursAttribueVisuellementDetail,
        // retirerCoursAttribueVisuellementDetail, ajouterEnseignantDynamiquement,
        // ajouterAuTableauSommaire, recalculerEtAfficherMoyenneChamp, initialiserTableauSommaire.
        // (Pour la concision, je ne les répète pas ici, elles sont identiques à la version précédente)

        // Copiez-collez ici l'intégralité du bloc <script> de la version précédente
        // à partir de la fonction initialiserToutesLesListesCondensees()
        // jusqu'à la fin de initialiserTableauSommaire().

        function initialiserToutesLesListesCondensees() {
            G_ENSEIGNANTS_INITIAL_DATA.forEach(enseignant => {
                regenererListeCondenseeAttributions(enseignant.enseignantid, enseignant.attributions || []);
            });
        }

        function regenererListeCondenseeAttributions(enseignantId, attributions) {
            const ulCondense = document.getElementById(`resume-attributions-list-${enseignantId}`);
            if (!ulCondense) return;
            ulCondense.innerHTML = ''; 

            if (!attributions || attributions.length === 0) {
                ulCondense.innerHTML = '<li class="no-attributions-condense">Aucun cours attribué.</li>';
                return;
            }

            const coursAgreges = {}; 
            attributions.forEach(attr => {
                if (!coursAgreges[attr.codecours]) {
                    coursAgreges[attr.codecours] = {
                        descriptif: attr.coursdescriptif,
                        nbPeriodesUnitaire: attr.nbperiodes, 
                        nbGroupes: 0,
                        totalPeriodesCours: 0
                    };
                }
                coursAgreges[attr.codecours].nbGroupes += attr.nbgroupespris; 
                coursAgreges[attr.codecours].totalPeriodesCours += attr.nbperiodes * attr.nbgroupespris;
            });

            const coursAgregesTries = Object.values(coursAgreges).sort((a, b) => 
                a.descriptif.localeCompare(b.descriptif)
            );

            coursAgregesTries.forEach(cours => {
                const li = document.createElement('li');
                li.textContent = `${cours.descriptif} (${cours.nbPeriodesUnitaire} pér. x ${cours.nbGroupes} grp) = ${cours.totalPeriodesCours} pér.`;
                ulCondense.appendChild(li);
            });
        }

        function gestionnaireClicsEnseignantsSection(event) {
            const target = event.target; 
            if (target.matches('.cours-selection button[data-enseignant-id][data-cours-code]')) {
                attribuerCours(target.dataset.enseignantId, target.dataset.coursCode, target.dataset.nbPeriodes, target);
            } 
            else if (target.classList.contains('btn-retirer-cours')) {
                if (confirm('Êtes-vous sûr de vouloir retirer ce cours ?')) {
                    retirerCours(target.dataset.attributionId, target);
                }
            } 
            else if (target.classList.contains('btn-supprimer-enseignant')) {
                if (confirm('Êtes-vous sûr de vouloir supprimer cette tâche restante et tous ses cours attribués ?')) {
                    supprimerEnseignantFictif(target.dataset.enseignantId, target);
                }
            }
        }

        async function attribuerCours(enseignantId, codeCours, nbPeriodesCours, boutonClique) {
            boutonClique.disabled = true; 
            boutonClique.textContent = '...'; 
            try {
                const response = await fetch('/api/attributions/ajouter', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enseignant_id: parseInt(enseignantId), code_cours: codeCours })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || "Erreur attribution cours.");
                }

                mettreAJourTotauxPeriodesEnseignant(enseignantId, data.periodes_enseignant);
                mettreAJourLigneSommaire(enseignantId, data.periodes_enseignant);
                recalculerEtAfficherMoyenneChamp();

                ajouterCoursAttribueVisuellementDetail(enseignantId, data.attribution_id, codeCours, nbPeriodesCours);
                regenererListeCondenseeAttributions(enseignantId, data.attributions_enseignant || []);

                mettreAJourDonneesGlobalesCours(codeCours, data.groupes_restants_cours);
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisir();

            } catch (error) {
                console.error('Erreur attribuerCours:', error);
                alert(error.message);
                boutonClique.disabled = false; 
                boutonClique.textContent = 'Attribuer';
            }
        }

        async function retirerCours(attributionId, boutonClique) {
            boutonClique.disabled = true; 
            boutonClique.textContent = '...'; 
            try {
                const response = await fetch('/api/attributions/supprimer', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ attribution_id: parseInt(attributionId) })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erreur retrait cours.');
                }

                mettreAJourTotauxPeriodesEnseignant(data.enseignant_id, data.periodes_enseignant);
                mettreAJourLigneSommaire(data.enseignant_id, data.periodes_enseignant);
                recalculerEtAfficherMoyenneChamp();

                retirerCoursAttribueVisuellementDetail(attributionId, data.enseignant_id);
                regenererListeCondenseeAttributions(data.enseignant_id, data.attributions_enseignant || []);

                mettreAJourDonneesGlobalesCours(data.code_cours, data.groupes_restants_cours);
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisir();

            } catch (error) {
                console.error('Erreur retirerCours:', error);
                alert(error.message);
                 boutonClique.disabled = false; 
                 boutonClique.textContent = 'Retirer';
            }
        }

        async function creerTacheRestante(boutonClique) {
            boutonClique.disabled = true;
            boutonClique.textContent = 'Création...';
            try {
                const response = await fetch(`/api/champs/${G_CHAMP_NO_ACTUEL}/taches_restantes/creer`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                if (!response.ok || !data.success || !data.enseignant) {
                    throw new Error(data.message || 'Erreur création tâche restante.');
                }

                G_ENSEIGNANTS_INITIAL_DATA.push(data.enseignant); 
                ajouterEnseignantDynamiquement(data.enseignant);
                const periodesInitiales = data.periodes_actuelles || {periodes_cours:0, periodes_autres:0, total_periodes:0};
                ajouterAuTableauSommaire(data.enseignant, periodesInitiales);
                recalculerEtAfficherMoyenneChamp(); 
            } catch (error) {
                console.error('Erreur creerTacheRestante:', error);
                alert(error.message);
            } finally {
                boutonClique.disabled = false;
                boutonClique.textContent = 'Créer une Tâche Restante';
            }
        }

        async function supprimerEnseignantFictif(enseignantId, boutonClique) {
            boutonClique.disabled = true;
            boutonClique.textContent = 'Suppression...';
            try {
                const response = await fetch(`/api/enseignants/${enseignantId}/supprimer`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erreur suppression tâche.');
                }

                document.getElementById(`enseignant-card-${enseignantId}`)?.remove();
                document.querySelector(`.sommaire-champ-section tbody tr[data-enseignant-id="${enseignantId}"]`)?.remove();

                G_ENSEIGNANTS_INITIAL_DATA = G_ENSEIGNANTS_INITIAL_DATA.filter(e => e.enseignantid !== parseInt(enseignantId));

                if (data.cours_liberes_details && data.cours_liberes_details.length > 0) {
                    data.cours_liberes_details.forEach(cours_maj => {
                        mettreAJourDonneesGlobalesCours(cours_maj.code_cours, cours_maj.nouveaux_groupes_restants);
                    });
                }
                regenererTableauCoursRestants();
                regenererToutesLesListesDeCoursAChoisir();
                recalculerEtAfficherMoyenneChamp(); 

            } catch (error) {
                console.error('Erreur supprimerEnseignantFictif:', error);
                alert(error.message);
                boutonClique.disabled = false; 
                boutonClique.textContent = 'Supprimer Tâche';
            }
        }

        function mettreAJourDonneesGlobalesCours(codeCours, nouveauxGrpRestants) {
            const coursTrouveE = G_COURS_ENSEIGNEMENT_CHAMP.find(c => c.codecours === codeCours);
            if (coursTrouveE) coursTrouveE.grprestant = nouveauxGrpRestants;

            const coursTrouveA = G_COURS_AUTRES_TACHES_CHAMP.find(c => c.codecours === codeCours);
            if (coursTrouveA) coursTrouveA.grprestant = nouveauxGrpRestants;
        }

        function regenererTableauCoursRestants() {
            const tbody = document.querySelector('#tableau-cours-restants tbody');
            if (!tbody) return; 
            tbody.innerHTML = ''; 

            const tousLesCoursDuChamp = [...G_COURS_ENSEIGNEMENT_CHAMP, ...G_COURS_AUTRES_TACHES_CHAMP]
                                      .sort((a,b) => a.codecours.localeCompare(b.codecours));

            const codesVus = new Set(); 
            tousLesCoursDuChamp.forEach(cours => {
                if (!codesVus.has(cours.codecours)) {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${cours.codecours}</td><td>${cours.coursdescriptif}</td><td>${cours.nbperiodes}</td><td id="grp-restant-${cours.codecours}">${cours.grprestant}</td>`;
                    codesVus.add(cours.codecours);
                }
            });

            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucun cours disponible ou tous les groupes sont attribués.</td></tr>';
            }
        }

        function regenererToutesLesListesDeCoursAChoisir() {
            document.querySelectorAll('.enseignant-card').forEach(card => {
                const enseignantId = card.id.split('-').pop(); 

                const ulEnseignement = card.querySelector('ul.liste-cours-a-choisir[data-type-cours="enseignement"]');
                if (ulEnseignement) {
                    ulEnseignement.innerHTML = genererListeHTMLCoursDispo(G_COURS_ENSEIGNEMENT_CHAMP, enseignantId, 'enseignement');
                }

                const ulAutres = card.querySelector('ul.liste-cours-a-choisir[data-type-cours="autre"]');
                if (ulAutres) {
                    ulAutres.innerHTML = genererListeHTMLCoursDispo(G_COURS_AUTRES_TACHES_CHAMP, enseignantId, 'autre');
                }
            });
        }

        function genererListeHTMLCoursDispo(listeCoursGlobale, enseignantId, typeCours) {
            let html = '';
            const coursFiltres = listeCoursGlobale; 

            if (coursFiltres.length > 0) {
                coursFiltres.forEach(cours => {
                    const estComplet = cours.grprestant <= 0;
                    html += `<li data-complet="${estComplet}">
                                ${cours.coursdescriptif} (${cours.nbperiodes} pér. - ${cours.grprestant} grp. rest.)
                                <button data-enseignant-id="${enseignantId}" data-cours-code="${cours.codecours}" 
                                        data-type="${typeCours}" data-nb-periodes="${cours.nbperiodes}"
                                        ${estComplet ? 'disabled title="Plus de groupes disponibles"' : ''}>
                                    ${estComplet ? 'Complet' : 'Attribuer'}
                                </button>
                             </li>`;
                });
            } else {
                html = `<li>Aucun cours de ce type disponible pour le moment.</li>`;
            }
            return html;
        }

        function mettreAJourTotauxPeriodesEnseignant(enseignantId, periodes) {
            document.getElementById(`total-ens-${enseignantId}`).textContent = periodes.periodes_cours;
            document.getElementById(`total-autre-${enseignantId}`).textContent = periodes.periodes_autres;
            document.getElementById(`total-gen-detail-${enseignantId}`).textContent = periodes.total_periodes;
            document.getElementById(`total-gen-condense-${enseignantId}`).textContent = periodes.total_periodes;
        }

        function mettreAJourLigneSommaire(enseignantId, periodes) {
            const ligne = document.querySelector(`.sommaire-champ-section tbody tr[data-enseignant-id="${enseignantId}"]`);
            if (ligne) {
                ligne.querySelector('.sum-cours-val').textContent = periodes.periodes_cours;
                ligne.querySelector('.sum-autres-val').textContent = periodes.periodes_autres;
                ligne.querySelector('.sum-total-val').textContent = periodes.total_periodes;
            }
        }

        function ajouterCoursAttribueVisuellementDetail(enseignantId, attributionId, codeCours, nbPeriodesCours) {
            const ulDetail = document.getElementById(`attributions-list-${enseignantId}`);
            if (!ulDetail) return;

            ulDetail.querySelector('.no-attributions')?.remove();

            const coursDataGlobal = [...G_COURS_ENSEIGNEMENT_CHAMP, ...G_COURS_AUTRES_TACHES_CHAMP].find(c => c.codecours === codeCours);
            const descriptionCours = coursDataGlobal ? coursDataGlobal.coursdescriptif : "Cours (info manquante)";
            const periodesEffectives = parseInt(nbPeriodesCours) || (coursDataGlobal ? coursDataGlobal.nbperiodes : 0);
            const nbGroupesPris = 1; 

            const liDetail = document.createElement('li');
            liDetail.dataset.attributionId = attributionId;
            liDetail.dataset.codecours = codeCours;
            liDetail.dataset.nbperiodes = periodesEffectives; 

            liDetail.innerHTML = `${descriptionCours} (${periodesEffectives} pér. x ${nbGroupesPris} grp) <button class="btn-retirer-cours" data-attribution-id="${attributionId}">Retirer</button>`;
            ulDetail.appendChild(liDetail);
        }

        function retirerCoursAttribueVisuellementDetail(attributionId, enseignantId) {
            const liDetail = document.querySelector(`#attributions-list-${enseignantId} li[data-attribution-id="${attributionId}"]`);
            if (liDetail) {
                const ulDetail = liDetail.parentNode;
                liDetail.remove();
                if (ulDetail.children.length === 0) {
                    ulDetail.innerHTML = '<li class="no-attributions">Aucun cours attribué pour le moment.</li>';
                }
            }
        }

        function ajouterEnseignantDynamiquement(enseignant) {
            const container = document.querySelector('.enseignants-section');
            const btnCreerTache = document.getElementById('btn-creer-tache-restante'); 

            const card = document.createElement('div');
            card.className = `enseignant-card ${!enseignant.esttempsplein ? 'enseignant-temps-partiel' : ''} ${enseignant.estfictif ? 'enseignant-fictif' : ''}`;
            card.id = `enseignant-card-${enseignant.enseignantid}`;

            card.innerHTML = `
                <div class="vue-condensee">
                    <h3 class="titre-enseignant-bascule">
                        <span>
                            ${enseignant.nomcomplet}
                            ${!enseignant.esttempsplein ? '<small>(Temps Partiel)</small>' : ''}
                            ${enseignant.estfictif ? '<small>(Tâche Restante)</small>' : ''}
                            ${enseignant.peutchoisirhorschampprincipal ? '<small>(Peut choisir hors champ)</small>' : ''}
                        </span>
                        <span class="arrow-indicator">▶</span>
                    </h3>
                    <div class="resume-cours-attribues">
                        <ul class="resume-cours-attribues-list" id="resume-attributions-list-${enseignant.enseignantid}">
                            <li class="no-attributions-condense">Aucun cours attribué.</li>
                        </ul>
                    </div>
                    <p><strong>Total Périodes:</strong> <span id="total-gen-condense-${enseignant.enseignantid}">0</span></p>
                </div>
                <div class="vue-detaillee-contenu">
                    ${enseignant.estfictif ? `<button class="btn-supprimer-enseignant" data-enseignant-id="${enseignant.enseignantid}" style="float:right; margin-bottom:5px;">Supprimer Tâche</button>` : ''}
                    <div class="cours-attribues"><h4>Cours Actuellement Attribués (Détail) :</h4><ul id="attributions-list-${enseignant.enseignantid}"><li class="no-attributions">Aucun cours attribué.</li></ul></div>
                    <div class="cours-selection"><h4>Cours d'enseignement disponibles :</h4><ul class="liste-cours-a-choisir" data-type-cours="enseignement">${genererListeHTMLCoursDispo(G_COURS_ENSEIGNEMENT_CHAMP, enseignant.enseignantid, 'enseignement')}</ul></div>
                    <div class="cours-selection"><h4>Autres tâches disponibles :</h4><ul class="liste-cours-a-choisir" data-type-cours="autre">${genererListeHTMLCoursDispo(G_COURS_AUTRES_TACHES_CHAMP, enseignant.enseignantid, 'autre')}</ul></div>
                    <p><strong>Total Périodes Enseignement:</strong> <span id="total-ens-${enseignant.enseignantid}">0</span></p>
                    <p><strong>Total Périodes Autres:</strong> <span id="total-autre-${enseignant.enseignantid}">0</span></p>
                    <p><strong>Total Général (Détail):</strong> <span id="total-gen-detail-${enseignant.enseignantid}">0</span></p>
                </div>
            `;

            if (btnCreerTache) {
                container.insertBefore(card, btnCreerTache);
            } else {
                container.appendChild(card);
            }

            card.querySelector('.titre-enseignant-bascule')?.addEventListener('click', function() {
                const currentCard = this.closest('.enseignant-card');
                 document.querySelectorAll('.enseignant-card.detail-visible').forEach(openCard => {
                    if (openCard !== currentCard) {
                        openCard.classList.remove('detail-visible');
                    }
                });
                currentCard.classList.toggle('detail-visible');
            });
        }

        function ajouterAuTableauSommaire(enseignant, periodes) {
            const tbody = document.querySelector('#tableau-sommaire-champ tbody');
            if (!tbody) return; 

            const row = tbody.insertRow();
            row.dataset.enseignantId = enseignant.enseignantid; 

            if (enseignant.estfictif) {
                row.classList.add('enseignant-fictif-sommaire');
            } else if (!enseignant.esttempsplein) {
                row.classList.add('enseignant-temps-partiel-sommaire');
            } else {
                row.classList.add('enseignant-temps-plein-sommaire'); 
            }

            row.innerHTML = `
                <td>${enseignant.nomcomplet}</td>
                <td class="sum-cours-val">${periodes.periodes_cours}</td>
                <td class="sum-autres-val">${periodes.periodes_autres}</td>
                <td class="sum-total-val">${periodes.total_periodes}</td>
                <td>${enseignant.estfictif ? 'Fictif' : (!enseignant.esttempsplein ? 'Temps Partiel' : 'Temps Plein')}</td>`;
        }

        function recalculerEtAfficherMoyenneChamp() {
            let totalPeriodes = 0;
            let countTempsPleinNonFictif = 0;

            document.querySelectorAll('#tableau-sommaire-champ tbody tr').forEach(row => {
                const estFictif = row.classList.contains('enseignant-fictif-sommaire');
                const estTempsPartiel = row.classList.contains('enseignant-temps-partiel-sommaire');
                if (!estFictif && !estTempsPartiel) {
                    const totalCell = row.querySelector('.sum-total-val');
                    if (totalCell) {
                        totalPeriodes += parseInt(totalCell.textContent) || 0;
                    }
                    countTempsPleinNonFictif++;
                }
            });

            const moyenne = countTempsPleinNonFictif > 0 ? (totalPeriodes / countTempsPleinNonFictif) : 0;
            document.getElementById('moyenne-champ-val').textContent = moyenne.toFixed(2);
        }

        function initialiserTableauSommaire() {
            const lignesSommaire = document.querySelectorAll('#tableau-sommaire-champ tbody tr');
            // Récupérer les données des enseignants du contexte global JS pour une association fiable
            const enseignantsData = G_ENSEIGNANTS_INITIAL_DATA; 

            lignesSommaire.forEach(row => {
                const nomEnseignantSommaire = row.cells[0].textContent.trim();
                // Trouver l'enseignant correspondant dans les données globales par nom
                // Ceci est plus robuste que de se fier à l'index si les listes ne sont pas parfaitement synchronisées.
                // Pour une solution encore meilleure, l'ID de l'enseignant devrait être inclus dans `taches_sommaire_champ`
                // et utilisé ici comme `data-enseignant-id` sur la ligne TR dès le rendu Jinja.
                // Pour l'instant, on assume que `taches_sommaire_champ` fournit `enseignant_id`.
                const enseignantIdAttendu = row.dataset.enseignantId; // Si Jinja a déjà mis l'ID
                let enseignantAssocie;

                if (enseignantIdAttendu) {
                     enseignantAssocie = enseignantsData.find(ens => String(ens.enseignantid) === enseignantIdAttendu);
                } else {
                    // Fallback sur le nom si l'ID n'est pas directement sur la row (moins idéal)
                    enseignantAssocie = enseignantsData.find(ens => ens.nomcomplet === nomEnseignantSommaire);
                }


                if (enseignantAssocie) {
                    // S'assurer que row.dataset.enseignantId est bien défini (surtout si on a utilisé le fallback par nom)
                    if (!row.dataset.enseignantId) {
                        row.dataset.enseignantId = enseignantAssocie.enseignantid;
                    }

                    // Appliquer les classes pour le calcul de la moyenne
                    if (enseignantAssocie.estfictif) {
                        row.classList.add('enseignant-fictif-sommaire');
                    } else if (!enseignantAssocie.esttempsplein) {
                        row.classList.add('enseignant-temps-partiel-sommaire');
                    } else {
                        row.classList.add('enseignant-temps-plein-sommaire');
                    }
                } else {
                    console.warn(`Aucun enseignant correspondant trouvé dans G_ENSEIGNANTS_INITIAL_DATA pour la ligne de sommaire: ${nomEnseignantSommaire} (ID attendu: ${enseignantIdAttendu})`);
                }
            });
            recalculerEtAfficherMoyenneChamp();
        }
    </script>
</body>
</html>